"use strict";(self.webpackChunkassurkin=self.webpackChunkassurkin||[]).push([[199],{2199:(P,l,s)=>{s.r(l),s.d(l,{PaymentComponent:()=>R});var u=s(467),e=s(4438),o=s(177),c=s(8212),p=s(9499),_=s(3161),m=s(5558),g=s(7673),v=s(3207);function f(n,i){1&n&&(e.j41(0,"div",5),e.nrm(1,"div",6),e.j41(2,"p",7),e.EFF(3,"Chargement..."),e.k0s()())}function y(n,i){if(1&n&&(e.j41(0,"div",8)(1,"span",9),e.EFF(2),e.k0s()()),2&n){const t=e.XpG();e.R7$(2),e.JRh(t.errorMessage)}}function E(n,i){1&n&&(e.j41(0,"div",12)(1,"p",13),e.EFF(2,"Aucune demande de paiement trouv\xe9e."),e.k0s()())}function b(n,i){1&n&&(e.j41(0,"span"),e.nrm(1,"i",26),e.EFF(2," Envoi..."),e.k0s())}function h(n,i){1&n&&(e.j41(0,"span"),e.nrm(1,"i",27),e.EFF(2," Relancer"),e.k0s())}function x(n,i){if(1&n){const t=e.RV6();e.j41(0,"button",25),e.bIt("click",function(){e.eBV(t);const a=e.XpG().$implicit,d=e.XpG(3);return e.Njj(d.resendReminder(a))}),e.DNE(1,b,3,0,"span",4)(2,h,3,0,"span",4),e.k0s()}if(2&n){const t=e.XpG().$implicit,r=e.XpG(3);e.Y8G("disabled",r.sendingEmailId===t.id),e.R7$(),e.Y8G("ngIf",r.sendingEmailId===t.id),e.R7$(),e.Y8G("ngIf",r.sendingEmailId!==t.id)}}function F(n,i){if(1&n&&(e.j41(0,"tr")(1,"td",18),e.EFF(2),e.nI1(3,"date"),e.k0s(),e.j41(4,"td",18)(5,"p",19),e.EFF(6),e.k0s()(),e.j41(7,"td",18)(8,"p",20),e.EFF(9),e.nI1(10,"currency"),e.k0s()(),e.j41(11,"td",18)(12,"span",21),e.nrm(13,"span",22),e.j41(14,"span",23),e.EFF(15),e.k0s()()(),e.j41(16,"td",18)(17,"p",19),e.EFF(18),e.k0s()(),e.j41(19,"td",18),e.DNE(20,x,3,3,"button",24),e.k0s()()),2&n){const t=i.$implicit,r=e.XpG(3);e.R7$(2),e.SpI(" ",e.i5U(3,8,t.created_at,"dd/MM/yyyy HH:mm")," "),e.R7$(4),e.JRh(t.sujet),e.R7$(3),e.SpI(" ",e.ii3(10,11,t.montant,"EUR","symbol","1.2-2")," "),e.R7$(3),e.Y8G("ngClass",r.getStatusClass(t.statut)),e.R7$(3),e.JRh(r.getStatusLabel(t.statut)),e.R7$(3),e.Lme(" ",t.quote_type," #",t.quote_id," "),e.R7$(2),e.Y8G("ngIf","pending"===t.statut)}}function I(n,i){if(1&n&&(e.j41(0,"div",14)(1,"table",15)(2,"thead")(3,"tr")(4,"th",16),e.EFF(5," Date "),e.k0s(),e.j41(6,"th",16),e.EFF(7," Sujet "),e.k0s(),e.j41(8,"th",16),e.EFF(9," Montant "),e.k0s(),e.j41(10,"th",16),e.EFF(11," Statut "),e.k0s(),e.j41(12,"th",16),e.EFF(13," Dossier "),e.k0s(),e.j41(14,"th",16),e.EFF(15," Actions "),e.k0s()()(),e.j41(16,"tbody"),e.DNE(17,F,21,16,"tr",17),e.k0s()()()),2&n){const t=e.XpG(2);e.R7$(17),e.Y8G("ngForOf",t.payments)}}function j(n,i){if(1&n&&(e.j41(0,"div"),e.DNE(1,E,3,0,"div",10)(2,I,18,1,"div",11),e.k0s()),2&n){const t=e.XpG();e.R7$(),e.Y8G("ngIf",0===t.payments.length),e.R7$(),e.Y8G("ngIf",t.payments.length>0)}}let R=(()=>{class n{paymentService=(0,e.WQX)(c.W);authService=(0,e.WQX)(p.u);mailService=(0,e.WQX)(_.t);payments=[];loading=!0;errorMessage=null;sendingEmailId=null;ngOnInit(){this.authService.currentUser$.pipe((0,m.n)(t=>t?this.paymentService.getPaymentRequestsByUser(t.id):(0,g.of)([]))).subscribe({next:t=>{this.payments=t,this.loading=!1},error:t=>{console.error("Erreur chargement historique paiements",t),this.errorMessage="Impossible de charger l'historique des paiements.",this.loading=!1}})}getStatusLabel(t){switch(t){case"pending":return"En attente";case"paid":return"Pay\xe9";case"failed":return"\xc9chou\xe9";case"cancelled":return"Annul\xe9";case"overdue":return"En retard";default:return t}}getStatusClass(t){switch(t){case"paid":return"bg-green-100 text-green-800";case"pending":return"bg-yellow-100 text-yellow-800";case"failed":case"overdue":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}}resendReminder(t){var r=this;return(0,u.A)(function*(){if(t.preneur_uid){if(confirm("Voulez-vous envoyer un rappel de paiement par e-mail au client ?")){r.sendingEmailId=t.id;try{const a=yield r.paymentService.getPersonDetails(t.preneur_uid);if(!a||!a.email)return void alert("Impossible de r\xe9cup\xe9rer l'email du client.");const d=`\n        <p>Bonjour ${a.prenom} ${a.nom},</p>\n        <p>Sauf erreur de notre part, nous sommes toujours dans l'attente du r\xe8glement concernant votre dossier ${t.quote_type} #${t.quote_id}.</p>\n        <p><strong>Objet :</strong> ${t.sujet}</p>\n        <p><strong>Montant \xe0 r\xe9gler :</strong> ${t.montant} \u20ac</p>\n        <p><strong>Date limite :</strong> ${new Date(t.date_echeance).toLocaleDateString()}</p>\n        <p>Merci de r\xe9gulariser votre situation dans les plus brefs d\xe9lais via votre espace client.</p>\n        <p>Cordialement,<br>L'\xe9quipe Assurkin</p>\n      `;yield(0,v.s)(r.mailService.sendEmail({to:a.email,subject:`Rappel : Paiement en attente - Dossier #${t.quote_id}`,htmlContent:d})),alert("Rappel envoy\xe9 avec succ\xe8s !")}catch(a){console.error("Erreur lors de l'envoi du rappel:",a),alert("Une erreur est survenue lors de l'envoi du rappel.")}finally{r.sendingEmailId=null}}}else alert("Impossible de relancer : aucun client associ\xe9 \xe0 ce paiement.")})()}static \u0275fac=function(r){return new(r||n)};static \u0275cmp=e.VBU({type:n,selectors:[["app-payment"]],standalone:!0,features:[e.aNF],decls:6,vars:3,consts:[[1,"container","mx-auto","px-4","py-8"],[1,"text-2xl","font-bold","mb-6","text-gray-800"],["class","text-center py-8",4,"ngIf"],["class","bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4","role","alert",4,"ngIf"],[4,"ngIf"],[1,"text-center","py-8"],[1,"inline-block","animate-spin","rounded-full","h-8","w-8","border-b-2","border-gray-900"],[1,"mt-2","text-gray-600"],["role","alert",1,"bg-red-100","border","border-red-400","text-red-700","px-4","py-3","rounded","relative","mb-4"],[1,"block","sm:inline"],["class","text-center py-8 bg-gray-50 rounded-lg",4,"ngIf"],["class","overflow-x-auto bg-white shadow-md rounded-lg",4,"ngIf"],[1,"text-center","py-8","bg-gray-50","rounded-lg"],[1,"text-gray-500"],[1,"overflow-x-auto","bg-white","shadow-md","rounded-lg"],[1,"min-w-full","leading-normal"],[1,"px-5","py-3","border-b-2","border-gray-200","bg-gray-100","text-left","text-xs","font-semibold","text-gray-600","uppercase","tracking-wider"],[4,"ngFor","ngForOf"],[1,"px-5","py-5","border-b","border-gray-200","bg-white","text-sm"],[1,"text-gray-900","whitespace-no-wrap"],[1,"text-gray-900","whitespace-no-wrap","font-bold"],[1,"relative","inline-block","px-3","py-1","font-semibold","leading-tight","rounded-full",3,"ngClass"],["aria-hidden","true",1,"absolute","inset-0","opacity-50","rounded-full"],[1,"relative"],["class","text-indigo-600 hover:text-indigo-900 font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150",3,"disabled","click",4,"ngIf"],[1,"text-indigo-600","hover:text-indigo-900","font-medium","disabled:opacity-50","disabled:cursor-not-allowed","transition-colors","duration-150",3,"click","disabled"],[1,"fas","fa-spinner","fa-spin","mr-1"],[1,"fas","fa-paper-plane","mr-1"]],template:function(r,a){1&r&&(e.j41(0,"div",0)(1,"h2",1),e.EFF(2,"Historique des demandes de paiement cr\xe9\xe9es"),e.k0s(),e.DNE(3,f,4,0,"div",2)(4,y,3,1,"div",3)(5,j,3,2,"div",4),e.k0s()),2&r&&(e.R7$(3),e.Y8G("ngIf",a.loading),e.R7$(),e.Y8G("ngIf",a.errorMessage),e.R7$(),e.Y8G("ngIf",!a.loading&&!a.errorMessage))},dependencies:[o.MD,o.YU,o.Sq,o.bT,o.oe,o.vh],encapsulation:2})}return n})()}}]);