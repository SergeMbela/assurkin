<div class="container mx-auto p-4 sm:p-6 lg:p-8">
  <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Gestion des Devis</h1>

  <!-- Barre d'onglets -->
  <div class="border-b border-gray-200 mb-6">
    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
      <button *ngFor="let tab of tabs"
              (click)="setActiveTab(tab.id)"
              [ngClass]="(activeTab$ | async) === tab.id
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
        {{ tab.label }}
      </button>
    </nav>
  </div>

  <!-- Champ de recherche -->
  <div class="mb-6">
    <input type="text"
           [formControl]="searchControl"
           placeholder="Rechercher par nom, ID, description..."           class="w-full max-w-md mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm">
  </div>

  <ng-container *ngIf="vm$ | async as vm">
    <app-state-container 
      [state]="vm.state"
      loadingMessage="Chargement des devis..."
      errorMessage="Une erreur est survenue lors du chargement des devis.">

      <!-- ===== AUCUNE DONNÉE ===== -->
      <div *ngIf="!vm.state.data || vm.state.data.quotes.length === 0" class="text-center py-10 px-4 bg-gray-50 rounded-lg">
        <p class="text-gray-500">Aucun devis trouvé pour cette catégorie ou correspondant à votre recherche.</p>
      </div>

      <!-- ===== TABLEAU DE DONNÉES ===== -->
      <div *ngIf="vm.state.data && vm.state.data.quotes.length > 0" class="shadow-md rounded-lg overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-600">
          <thead class="text-xs text-gray-700 uppercase bg-gray-100">
            <tr class="border-b">
              <th scope="col" class="px-6 py-3">ID Devis</th>
              <th scope="col" class="px-6 py-3">Preneur</th>
              <!-- Colonne dynamique -->
              <th scope="col" class="px-6 py-3">{{ (activeTab$ | async) === 'auto' ? 'Véhicule' : 'Description' }}</th>
              <th scope="col" class="px-6 py-3">Date de la demande</th>
              <th scope="col" class="px-6 py-3">Statut</th>
              <th scope="col" class="px-6 py-3">Clients</th>
              <th scope="col" class="px-6 py-3">Documents</th>
              <th scope="col" class="px-6 py-3">Détails</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let quote of vm.state.data.quotes" class="bg-white border-b hover:bg-gray-50 transition-colors duration-200">
              <td class="px-6 py-4 font-semibold text-gray-900 whitespace-nowrap">#{{ quote.id }}</td>
              <td class="px-6 py-4">{{ quote.prenom }} {{ quote.nom }}</td>
              <td class="px-6 py-4 truncate max-w-xs">
                <ng-container *ngIf="isAutoQuote(quote)">
                  {{ quote.typeVehicule }} {{ quote.marqueVehicule }} {{ quote.modeleVehicule }}
                </ng-container>
                <ng-container *ngIf="isDescriptionQuote(quote)">
                  {{ quote.description }}
                </ng-container>
              </td>
              <td class="px-6 py-4">{{ quote.dateDemande | date:'dd/MM/yyyy HH:mm' }}</td>
              <td class="px-6 py-4">                
                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium" [ngClass]="{ 
                  'bg-blue-100 text-blue-800': quote.statut === 'Nouveau', 
                  'bg-yellow-100 text-yellow-800': quote.statut === 'En cours' || quote.statut === 'En attente', 
                  'bg-green-100 text-green-800': quote.statut === 'Terminé' }">
                  {{ quote.statut || 'Nouveau' }}
                </span>
              </td>
              <td class="px-6 py-4">
                <a [routerLink]="['/management', (activeTab$ | async), quote.id]" class="text-blue-600 hover:text-blue-800 font-medium">Gérer</a>
              </td>
              <td class="px-6 py-4">
                <a [routerLink]="['/management/upload', (activeTab$ | async), quote.id]" class="text-blue-600 hover:text-blue-800 font-medium">Gérer</a>
              </td>
              <td class="px-6 py-4">
                <button (click)="viewDetails(quote.id)" class="text-indigo-600 hover:text-indigo-800 font-medium">Voir détails</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    <!-- ===== CONTRÔLES DE PAGINATION ===== -->
    <div *ngIf="vm.pagination && vm.pagination.totalPages > 1" class="flex items-center justify-between mt-6">
      <span class="text-sm text-gray-700">
        Page <span class="font-semibold">{{ vm.pagination.currentPage }}</span> sur <span class="font-semibold">{{ vm.pagination.totalPages }}</span> ({{ vm.pagination.totalItems }} résultats)
      </span>

      <div class="inline-flex -space-x-px">
        <button (click)="goToPage(vm.pagination.currentPage - 1)"
                [disabled]="vm.pagination.currentPage === 1"
                class="px-3 py-2 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
          Précédent
        </button>
        <button (click)="goToPage(vm.pagination.currentPage + 1)"
                [disabled]="vm.pagination.currentPage === vm.pagination.totalPages"
                class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
          Suivant
        </button>
      </div>
    </div>

    </app-state-container>
  </ng-container>
</div>
