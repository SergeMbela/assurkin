<div class="container mx-auto p-4">
  <a routerLink="/management" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 mb-4 group">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 transition-transform group-hover:-translate-x-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
    Retour à la liste
  </a>
  <div *ngIf="quoteDetails$ | async as details; else loading">
    <h1 class="text-2xl font-bold mb-4">Détails de l'offre #{{ quoteId }} - {{ quoteType | titlecase }}</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Informations du devis -->
      <div class="bg-white shadow-md rounded-lg p-6">
        <form [formGroup]="quoteUpdateForm" (ngSubmit)="updateQuoteDetails()" class="space-y-6">
          <h2 class="text-xl font-semibold border-b pb-2">Mettre à jour le devis</h2>
          
          <!-- Section Preneur d'assurance -->
          <div *ngIf="quoteType === 'auto' || quoteType === 'habitation' || quoteType === 'rc' || quoteType === 'voyage'" formGroupName="Preneur d'assurance">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Preneur d'assurance</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <div>
                <label for="firstName" class="block text-sm font-medium text-gray-700">Prénom</label>
                <input type="text" id="firstName" formControlName="firstName" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="lastName" class="block text-sm font-medium text-gray-700">Nom</label>
                <input type="text" id="lastName" formControlName="lastName" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="dateNaissance" class="block text-sm font-medium text-gray-700">Date de naissance</label>
                <input type="date" id="dateNaissance" formControlName="dateNaissance" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="email" formControlName="email" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="phone" class="block text-sm font-medium text-gray-700">Téléphone</label>
                <input type="tel" id="phone" formControlName="phone" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="address" class="block text-sm font-medium text-gray-700">Adresse</label>
                <input type="text" id="address" formControlName="address" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="postalCode" class="block text-sm font-medium text-gray-700">Code Postal</label>
                <input type="text" id="postalCode" formControlName="postalCode" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="city" class="block text-sm font-medium text-gray-700">Ville</label>
                <input type="text" id="city" formControlName="city" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <!-- Champs spécifiques à l'assurance auto -->
              <ng-container *ngIf="quoteType === 'auto'">
                <div>
                  <label for="driverLicenseNumber" class="block text-sm font-medium text-gray-700">N° de permis</label>
                  <input type="text" id="driverLicenseNumber" formControlName="driverLicenseNumber" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                  <label for="driverLicenseDate" class="block text-sm font-medium text-gray-700">Date d'obtention permis</label>
                  <input type="date" id="driverLicenseDate" formControlName="driverLicenseDate" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
              </ng-container>
              <div class="sm:col-span-2">
                <label for="nationalRegistryNumber" class="block text-sm font-medium text-gray-700">Numéro national belge</label>
                <input type="text" id="nationalRegistryNumber" formControlName="nationalRegistryNumber" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" appNationalNumberFormat placeholder="XX.XX.XX-XXX.XX" maxlength="15">
                <div *ngIf="quoteUpdateForm.get('Preneur d\'assurance.nationalRegistryNumber')?.invalid && quoteUpdateForm.get('Preneur d\'assurance.nationalRegistryNumber')?.touched" class="text-red-600 text-sm mt-1">
                  <div *ngIf="quoteUpdateForm.get('Preneur d\'assurance.nationalRegistryNumber')?.hasError('invalidFormat')">
                    Le format doit être XX.XX.XX-XXX.XX.
                  </div>
                  <div *ngIf="quoteUpdateForm.get('Preneur d\'assurance.nationalRegistryNumber')?.hasError('invalidChecksum')">
                    Le numéro national est invalide.
                  </div>
                </div>
              </div>
              <div>
                <label for="idCardNumber" class="block text-sm font-medium text-gray-700">N° carte d'identité</label>
                <input type="text" id="idCardNumber" formControlName="idCardNumber" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" appIdCardFormat placeholder="XXX-XXXXXXX-XX" maxlength="15">
              </div>
              <div>
                <label for="idCardValidityDate" class="block text-sm font-medium text-gray-700">Date de validité CI</label>
                <input type="date" id="idCardValidityDate" formControlName="idCardValidityDate" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="nationality" class="block text-sm font-medium text-gray-700">Nationalité</label>
                <select id="nationality" formControlName="nationality" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <option [ngValue]="null" disabled>Sélectionnez une nationalité</option>
                  <option *ngFor="let nat of (nationalities$ | async)" [value]="nat.nationality">
                    {{ nat.nationality }}
                  </option>
                </select>
              </div>
              <div>
                <label for="maritalStatus" class="block text-sm font-medium text-gray-700">Statut marital</label>
                <select id="maritalStatus" formControlName="maritalStatus" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <option [ngValue]="null" disabled>Sélectionnez un statut</option>
                  <option value="Célibataire">Célibataire</option>
                  <option value="Marié(e)">Marié(e)</option>
                  <option value="Co-habitant">Co-habitant</option>
                  <option value="Divorcé(e)">Divorcé(e)</option>
                  <option value="Veuf/Veuve">Veuf/Veuve</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Section Preneur d'assurance (spécifique Obsèques) -->
          <div *ngIf="quoteType === 'obseques'" formGroupName="Preneur Obsèques">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Preneur d'assurance</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <div>
                <label for="firstName" class="block text-sm font-medium text-gray-700">Prénom</label>
                <input type="text" id="firstName" formControlName="firstName" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="lastName" class="block text-sm font-medium text-gray-700">Nom</label>
                <input type="text" id="lastName" formControlName="lastName" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="dateNaissance" class="block text-sm font-medium text-gray-700">Date de naissance</label>
                <input type="date" id="dateNaissance" formControlName="dateNaissance" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="email" formControlName="email" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="phone" class="block text-sm font-medium text-gray-700">Téléphone</label>
                <input type="tel" id="phone" formControlName="phone" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="address" class="block text-sm font-medium text-gray-700">Adresse</label>
                <input type="text" id="address" formControlName="address" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="postalCode" class="block text-sm font-medium text-gray-700">Code Postal</label>
                <input type="text" id="postalCode" formControlName="postalCode" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="city" class="block text-sm font-medium text-gray-700">Ville</label>
                <input type="text" id="city" formControlName="city" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
            </div>
          </div>

          <!-- Section Conducteur principal (conditionnelle) -->
          <div formGroupName="Conducteur principal" *ngIf="quoteType === 'auto' && showMainDriverSection">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Conducteur principal</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <div>
                <label for="main-driver-firstName" class="block text-sm font-medium text-gray-700">Prénom</label>
                <input type="text" id="main-driver-firstName" formControlName="firstName" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="main-driver-lastName" class="block text-sm font-medium text-gray-700">Nom</label>
                <input type="text" id="main-driver-lastName" formControlName="lastName" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="main-driver-dateNaissance" class="block text-sm font-medium text-gray-700">Date de naissance</label>
                <input type="date" id="main-driver-dateNaissance" formControlName="dateNaissance" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="main-driver-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="main-driver-email" formControlName="email" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="main-driver-phone" class="block text-sm font-medium text-gray-700">Téléphone</label>
                <input type="tel" id="main-driver-phone" formControlName="phone" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="main-driver-address" class="block text-sm font-medium text-gray-700">Adresse</label>
                <input type="text" id="main-driver-address" formControlName="address" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="main-driver-postalCode" class="block text-sm font-medium text-gray-700">Code Postal</label>
                <input type="text" id="main-driver-postalCode" formControlName="postalCode" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="main-driver-city" class="block text-sm font-medium text-gray-700">Ville</label>
                <input type="text" id="main-driver-city" formControlName="city" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="main-driver-driverLicenseNumber" class="block text-sm font-medium text-gray-700">N° de permis</label>
                <input type="text" id="main-driver-driverLicenseNumber" formControlName="driverLicenseNumber" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="main-driver-driverLicenseDate" class="block text-sm font-medium text-gray-700">Date d'obtention permis</label>
                <input type="date" id="main-driver-driverLicenseDate" formControlName="driverLicenseDate" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="main-driver-nationalRegistryNumber" class="block text-sm font-medium text-gray-700">Numéro national belge</label>
                <input type="text" id="main-driver-nationalRegistryNumber" formControlName="nationalRegistryNumber" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" appNationalNumberFormat placeholder="XX.XX.XX-XXX.XX" maxlength="15">
                <div *ngIf="quoteUpdateForm.get('Conducteur principal.nationalRegistryNumber')?.invalid && quoteUpdateForm.get('Conducteur principal.nationalRegistryNumber')?.touched" class="text-red-600 text-sm mt-1">
                  <div *ngIf="quoteUpdateForm.get('Conducteur principal.nationalRegistryNumber')?.hasError('invalidFormat')">
                    Le format doit être XX.XX.XX-XXX.XX.
                  </div>
                  <div *ngIf="quoteUpdateForm.get('Conducteur principal.nationalRegistryNumber')?.hasError('invalidChecksum')">
                    Le numéro national est invalide.
                  </div>
                </div>
              </div>
              <div>
                <label for="main-driver-nationality" class="block text-sm font-medium text-gray-700">Nationalité</label>
                <select id="main-driver-nationality" formControlName="nationality" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <option [ngValue]="null" disabled>Sélectionnez une nationalité</option>
                  <option *ngFor="let nat of (nationalities$ | async)" [value]="nat.nationality">
                    {{ nat.nationality }}
                  </option>
                </select>
              </div>
              <div>
                <label for="main-driver-idCardNumber" class="block text-sm font-medium text-gray-700">N° carte d'identité</label>
                <input type="text" id="main-driver-idCardNumber" formControlName="idCardNumber" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" appIdCardFormat placeholder="XXX-XXXXXXX-XX" maxlength="15">
              </div>
              <div>
                <label for="main-driver-idCardValidityDate" class="block text-sm font-medium text-gray-700">Date de validité CI</label>
                <input type="date" id="main-driver-idCardValidityDate" formControlName="idCardValidityDate" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="main-driver-maritalStatus" class="block text-sm font-medium text-gray-700">Statut marital</label>
                <select id="main-driver-maritalStatus" formControlName="maritalStatus" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <option [ngValue]="null" disabled>Sélectionnez un statut</option>
                  <option value="Célibataire">Célibataire</option>
                  <option value="Marié(e)">Marié(e)</option>
                  <option value="Co-habitant">Co-habitant</option>
                  <option value="Divorcé(e)">Divorcé(e)</option>
                  <option value="Veuf/Veuve">Veuf/Veuve</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Section Véhicule -->
          <div formGroupName="Véhicule" *ngIf="quoteType === 'auto'">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Véhicule</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <div class="relative">
                <label for="make" class="block text-sm font-medium text-gray-700">Marque</label>
                <input type="text" id="make" [formControl]="marqueCtrl" placeholder="Rechercher une marque..." class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <div *ngIf="isMarqueLoading" class="absolute inset-y-0 right-0 flex items-center pr-3 top-6">
                  <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </div>
                <ul *ngIf="(filteredMarques$ | async)?.length" class="absolute z-20 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto">
                  <li *ngFor="let marque of filteredMarques$ | async" (click)="selectMarque(marque)" class="px-3 py-2 cursor-pointer hover:bg-gray-100">
                    {{ marque.nom }}
                  </li>
                </ul>
              </div>
              <div>
                <div class="relative">
                  <label for="model" class="block text-sm font-medium text-gray-700">Modèle</label>
                  <select id="model" formControlName="model" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm disabled:bg-gray-100" [disabled]="!selectedMarqueId || isModeleLoading">
                    <option value="" disabled>Sélectionnez un modèle</option>
                    <option *ngIf="!isModeleLoading && modelesForSelectedMarque.length === 0 && selectedMarqueId" [disabled]="true">
                      Aucun modèle trouvé
                    </option>
                    <option *ngFor="let modele of modelesForSelectedMarque" [value]="modele.nom">{{ modele.nom }}</option>
                  </select>
                  <div *ngIf="isModeleLoading" class="absolute inset-y-0 right-0 flex items-center pr-3 top-6">
                    <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                  </div>
                </div>
              </div>
              <div>
                <label for="year" class="block text-sm font-medium text-gray-700">Année</label>
                <select id="year" formControlName="year" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <option [ngValue]="null" disabled>Sélectionnez une année</option>
                  <option *ngFor="let year of vehicleYears" [value]="year">
                    {{ year }}
                  </option>
                </select>
              </div>
              <div>
                <label for="licensePlate" class="block text-sm font-medium text-gray-700">Plaque</label>
                <input type="text" id="licensePlate" formControlName="licensePlate" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" appLicensePlateFormat placeholder="1 ABC 123" maxlength="9">
              </div>
            </div>
          </div>

          <!-- Section Garantie -->
          <div formGroupName="Garantie" *ngIf="quoteType === 'auto'">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Garanties</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <div class="sm:col-span-2">
                <label for="effectiveDate" class="block text-sm font-medium text-gray-700">Date d'effet</label>
                <input type="date" id="effectiveDate" formControlName="effectiveDate" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="omniumLevel" class="block text-sm font-medium text-gray-700">Niveau d'omnium</label>
                <select id="omniumLevel" formControlName="omniumLevel" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <option value="">Aucune</option>
                  <option value="mini">Mini Omnium</option>
                  <option value="complete">Omnium Complète</option>
                </select>
              </div>
              <div class="flex items-center">
                <input id="baseRC" type="checkbox" formControlName="baseRC" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="baseRC" class="ml-2 block text-sm text-gray-900">Garantie RC de base</label>
              </div>
              <div class="flex items-center">
                <input id="driverCoverage" type="checkbox" formControlName="driverCoverage" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="driverCoverage" class="ml-2 block text-sm text-gray-900">Garantie Conducteur</label>
              </div>
              <div class="flex items-center">
                <input id="assistance" type="checkbox" formControlName="assistance" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="assistance" class="ml-2 block text-sm text-gray-900">Assistance</label>
              </div>
            </div>
          </div>

          <!-- Section Bâtiment (pour assurance habitation) -->
          <div formGroupName="Bâtiment" *ngIf="quoteType === 'habitation' && quoteUpdateForm.get('Bâtiment')">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Bâtiment</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <div class="sm:col-span-2">
                <label for="batiment_adresse" class="block text-sm font-medium text-gray-700">Adresse du bâtiment</label>
                <input type="text" id="batiment_adresse" formControlName="adresse" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="batiment_code_postal" class="block text-sm font-medium text-gray-700">Code Postal</label>
                <input type="text" id="batiment_code_postal" formControlName="codePostal" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="batiment_ville" class="block text-sm font-medium text-gray-700">Ville</label>
                <input type="text" id="batiment_ville" formControlName="ville" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div class="sm:col-span-2">
                <label for="batiment_type_maison" class="block text-sm font-medium text-gray-700">Type de maison</label>
                <input type="text" id="batiment_type_maison" formControlName="typeMaison" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
            </div>
          </div>

          <!-- Section Évaluation (pour assurance habitation) -->
          <div formGroupName="Évaluation" *ngIf="quoteType === 'habitation'">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Évaluation</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <div>
                <label for="evaluation_superficie" class="block text-sm font-medium text-gray-700">Superficie (m²)</label>
                <input type="number" id="evaluation_superficie" formControlName="superficie" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="evaluation_nombre_pieces" class="block text-sm font-medium text-gray-700">Nombre de pièces</label>
                <input type="number" id="evaluation_nombre_pieces" formControlName="nombrePieces" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="evaluation_loyer_mensuel" class="block text-sm font-medium text-gray-700">Loyer mensuel (€)</label>
                <input type="number" id="evaluation_loyer_mensuel" formControlName="loyerMensuel" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              </div>
            </div>
          </div>

          <!-- Section Garanties Habitation -->
          <div formGroupName="Garanties Habitation" *ngIf="quoteType === 'habitation'">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Garanties Habitation</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <div class="flex items-center">
                <input id="garantie_contenu" type="checkbox" formControlName="contenu" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="garantie_contenu" class="ml-2 block text-sm text-gray-900">Garantie Contenu</label>
              </div>
              <div class="flex items-center">
                <input id="garantie_vol" type="checkbox" formControlName="vol" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="garantie_vol" class="ml-2 block text-sm text-gray-900">Garantie Vol</label>
              </div>
              <div class="flex items-center">
                <input id="garantie_pertes_indirectes" type="checkbox" formControlName="pertesIndirectes" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="garantie_pertes_indirectes" class="ml-2 block text-sm text-gray-900">Pertes Indirectes</label>
              </div>
              <div class="flex items-center">
                <input id="garantie_protection_juridique" type="checkbox" formControlName="protectionJuridique" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="garantie_protection_juridique" class="ml-2 block text-sm text-gray-900">Protection Juridique</label>
              </div>
            </div>
          </div>

          <!-- Section Assurés (pour assurance obsèques) -->
          <div formGroupName="Assurés" *ngIf="quoteType === 'obseques'">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Assurés</h3>
            <div class="space-y-6">
              <div class="flex items-center">
                <input id="preneurEstAssure" type="checkbox" formControlName="preneurEstAssure" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="preneurEstAssure" class="ml-2 block text-sm text-gray-900">Le preneur est aussi l'un des assurés</label>
              </div>

              <div formArrayName="assures" class="space-y-4">
                <div *ngFor="let assure of assures.controls; let i=index" [formGroupName]="i" class="p-4 border rounded-md">
                  <h4 class="font-semibold mb-2">Assuré {{ i + 1 }}</h4>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                      <label [for]="'assure-prenom-' + i" class="block text-sm font-medium text-gray-700">Prénom</label>
                      <input type="text" [id]="'assure-prenom-' + i" formControlName="prenom" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                      <label [for]="'assure-nom-' + i" class="block text-sm font-medium text-gray-700">Nom</label>
                      <input type="text" [id]="'assure-nom-' + i" formControlName="nom" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                      <label [for]="'assure-dateNaissance-' + i" class="block text-sm font-medium text-gray-700">Date de naissance</label>
                      <input type="date" [id]="'assure-dateNaissance-' + i" formControlName="dateNaissance" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                      <label [for]="'assure-capital-' + i" class="block text-sm font-medium text-gray-700">Capital assuré (€)</label>
                      <input type="number" [id]="'assure-capital-' + i" formControlName="capital" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" (click)="addAssure()" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Ajouter un assuré</button>
            </div>
          </div>

          <!-- ======================================= -->
          <!-- SECTION: DÉTAILS DU VOYAGE              -->
          <!-- ======================================= -->
          <div *ngIf="quoteType === 'voyage'">
            <h3 class="text-lg font-semibold text-gray-800 bg-gray-100 -mx-6 px-6 py-2 mb-4 border-y">Détails de la demande de voyage</h3>
            <div class="space-y-4">
              <label for="voyage-description" class="block text-sm font-medium text-gray-700">Message / Description</label>
              <textarea id="voyage-description" formControlName="description" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
            </div>
          </div>

          <!-- Bouton de soumission -->
          <div class="pt-4">
            <button type="submit" [disabled]="quoteUpdateForm.invalid || quoteUpdateForm.pristine" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
              Mettre à jour les informations
            </button>
          </div>
        </form>
      </div>

      <!-- Création du contrat -->
      <div class="bg-white shadow-md rounded-lg p-6">
        <form [formGroup]="contractForm" (ngSubmit)="saveContract()" class="space-y-6">
          <h2 class="text-xl font-semibold border-b pb-2">Créer un contrat</h2>
          <div class="space-y-4">
            <label for="date_contrat" class="block text-sm font-medium text-gray-700">Date du contrat</label>
            <input type="date" id="date_contrat" formControlName="date_contrat" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
          </div>

          <div class="space-y-4">
            <label for="periodicite" class="block text-sm font-medium text-gray-700">Périodicité</label>
            <select id="periodicite" formControlName="periodicite" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <option value="mensuel">Mensuel</option>
              <option value="trimestriel">Trimestriel</option>
              <option value="annuel">Annuel</option>
            </select>
          </div>

          <div class="space-y-4">
            <label for="compagnie" class="block text-sm font-medium text-gray-700">Compagnie</label>
            <select id="compagnie" formControlName="compagnie_id" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <option [ngValue]="null" disabled>Sélectionnez une compagnie</option>
              <option *ngFor="let compagnie of (allCompagnies$ | async)" [value]="compagnie.id">
                {{ compagnie.nom }}
              </option>
            </select>
          </div>

          <!-- Champ pour téléverser des fichiers (uniquement pour l'assurance auto) -->
          <div *ngIf="quoteType === 'auto'" class="space-y-4">
            <label for="fichiers_contrat" class="block text-sm font-medium text-gray-700">Téléverser des fichiers (contrat, etc.)</label>
            <input type="file" id="fichiers_contrat"
                   (change)="onFileSelected($event)"
                   multiple
                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
          </div>

          <div class="flex items-center pt-2">
            <input id="rappel" type="checkbox" formControlName="rappel" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="rappel" class="ml-2 block text-sm text-gray-900">Rappel</label>
          </div>

          <div>
            <button type="submit" [disabled]="contractForm.invalid" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400">
              Enregistrer le contrat
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <ng-template #loading>Chargement des Détails de l'offre...</ng-template>
</div>