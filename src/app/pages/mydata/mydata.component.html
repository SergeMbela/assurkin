<div class="container mx-auto p-4 py-16 sm:py-24">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

    <!-- Colonne de gauche : Navigation -->
    <div class="lg:col-span-1">
      <div class="bg-white p-4 rounded-lg shadow-md">
        <ul class="space-y-2">
          <li>
            <a (click)="setView('donnees')" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg cursor-pointer group hover:shadow" [ngClass]="{'bg-gray-100 hover:bg-gray-200': activeView === 'donnees', 'hover:bg-gray-100': activeView !== 'donnees'}">
              <i class="fas fa-user-circle w-6 h-6 text-gray-500"></i>
              <span class="ml-3">Mes Données</span>
            </a>
          </li>
          <li>
            <a (click)="setView('habitation')" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg cursor-pointer group hover:shadow" [ngClass]="{'bg-gray-100 hover:bg-gray-200': activeView === 'habitation', 'hover:bg-gray-100': activeView !== 'habitation'}">
              <i class="fas fa-home w-6 h-6 text-gray-500"></i>
              <span class="ml-3">Habitation</span>
            </a>
          </li>
          <li>
            <a (click)="setView('auto')" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg cursor-pointer group hover:shadow" [ngClass]="{'bg-gray-100 hover:bg-gray-200': activeView === 'auto', 'hover:bg-gray-100': activeView !== 'auto'}">
              <i class="fas fa-car w-6 h-6 text-gray-500"></i>
              <span class="ml-3">Assurance Auto</span>
            </a>
          </li>
          <li>
            <a (click)="setView('obseques')" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg cursor-pointer group hover:shadow" [ngClass]="{'bg-gray-100 hover:bg-gray-200': activeView === 'obseques', 'hover:bg-gray-100': activeView !== 'obseques'}">
              <i class="fas fa-hand-holding-heart w-6 h-6 text-gray-500"></i>
              <span class="ml-3">Obsèques</span>
            </a>
          </li>
          <li>
            <a (click)="setView('juridique')" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg cursor-pointer group hover:shadow" [ngClass]="{'bg-gray-100 hover:bg-gray-200': activeView === 'juridique', 'hover:bg-gray-100': activeView !== 'juridique'}">
              <i class="fas fa-balance-scale w-6 h-6 text-gray-500"></i>
              <span class="ml-3">Protection Juridique</span>
            </a>
          </li>
          <li>
            <a (click)="setView('voyage')" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg cursor-pointer group hover:shadow" [ngClass]="{'bg-gray-100 hover:bg-gray-200': activeView === 'voyage', 'hover:bg-gray-100': activeView !== 'voyage'}">
              <i class="fas fa-plane-slash w-6 h-6 text-gray-500"></i>
              <span class="ml-3">Annulation Voyage</span>
            </a>
          </li>
          <li>
            <a (click)="setView('documents')" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg cursor-pointer group hover:shadow" [ngClass]="{'bg-gray-100 hover:bg-gray-200': activeView === 'documents', 'hover:bg-gray-100': activeView !== 'documents'}">
              <i class="fas fa-folder w-6 h-6 text-gray-500"></i>
              <span class="ml-3">Mes Documents</span>
            </a>
          </li>
          <li>
            <a (click)="setView('paiement')" class="flex items-center p-3 text-base font-bold text-gray-900 rounded-lg cursor-pointer group hover:shadow" [ngClass]="{'bg-gray-100 hover:bg-gray-200': activeView === 'paiement', 'hover:bg-gray-100': activeView !== 'paiement'}">
              <i class="fas fa-credit-card w-6 h-6 text-gray-500"></i>
              <span class="ml-3">Paiement</span>
            </a>
          </li>
          <!-- Bouton de déconnexion -->
          <li class="border-t pt-2 mt-2">
            <a (click)="logout()" class="flex items-center p-3 text-base font-bold text-red-600 rounded-lg cursor-pointer hover:bg-red-50 group hover:shadow">
              <i class="fas fa-sign-out-alt w-6 h-6 text-red-500"></i>
              <span class="ml-3">Déconnexion</span>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Colonne de droite : Contenu -->
    <div class="lg:col-span-3">
      <div class="bg-white p-8 rounded-lg shadow-md">
        <!-- Section Mes Données -->
        <div *ngIf="activeView === 'donnees'">
          <div *ngIf="loading" class="text-center">
            <p>Chargement des données...</p>
          </div>
          <div *ngIf="!loading && user">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Mes Données Personnelles</h2>
            <div class="space-y-4">
              <div>
                <h3 class="text-lg font-semibold text-gray-700">Adresse e-mail</h3>
                <p class="text-gray-600">{{ user.email }}</p>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-700">Dernière connexion</h3>
                <p class="text-gray-600">{{ user.last_sign_in_at | date:'dd/MM/yyyy à HH:mm' }}</p>
              </div>
            </div>
          </div>
          <div *ngIf="!loading && !user" class="text-center text-gray-500"><p>Vous n'êtes pas connecté.</p></div>
        </div>

        <!-- Sections des contrats -->
        <div *ngIf="activeView === 'auto' || activeView === 'habitation' || activeView === 'obseques'">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Mes contrats {{ activeView | titlecase }}</h2>
          <div *ngIf="contractsLoading" class="text-center"><p>Chargement des contrats...</p></div>
          <div *ngIf="!contractsLoading && contracts.length > 0" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catégorie</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ activeView === 'auto' ? 'Véhicule' : (activeView === 'habitation' ? 'Bâtiment' : 'Description') }}</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Contrat</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Validité</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let contract of contracts">
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contract.categorie }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ contract.denomination }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contract.date_contract | date:'dd/MM/yyyy' }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contract.date_validite | date:'dd/MM/yyyy' }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" [ngClass]="{'bg-green-100 text-green-800': contract.statut === 'accepté', 'bg-red-100 text-red-800': contract.statut === 'refusé', 'bg-yellow-100 text-yellow-800': contract.statut === 'en attente'}">{{ contract.statut }}</span></td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <!-- Liens mis à jour pour naviguer vers la route unifiée avec le state -->
                    <a [routerLink]="['/assurance-details', contract.id]" [state]="{ type: activeView }"
                       class="text-indigo-600 hover:text-indigo-900">Détails</a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="!contractsLoading && contracts.length === 0" class="text-center text-gray-500"><p>Aucun contrat trouvé pour cette catégorie.</p></div>
        </div>

        <!-- Section Mes Documents -->
        <div *ngIf="activeView === 'documents'">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Mes Documents</h2>
          <div *ngIf="documentsLoading" class="text-center"><p>Chargement des documents...</p></div>
          <div *ngIf="!documentsLoading && documents.length > 0" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom du fichier</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sujet</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date d'ajout</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let doc of documents">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    <i class="fas fa-file-alt mr-2 text-gray-500"></i>
                    {{ doc.file_name }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.raisons }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.date_created | date:'dd/MM/yyyy' }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a (click)="openDocument(doc)" title="Télécharger le document" class="text-indigo-600 hover:text-indigo-900 cursor-pointer">
                      <i class="fas fa-download"></i>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="!documentsLoading && documents.length === 0" class="text-center text-gray-500">
            <p>Aucun document trouvé.</p>
          </div>
        </div>

        <!-- Section Paiement -->
        <div *ngIf="activeView === 'paiement'">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Mes Paiements</h2>

          <!-- Historique des demandes de paiement -->
          <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Historique des demandes de paiement</h3>
            <div *ngIf="paymentRequestsLoading" class="text-center"><p>Chargement de l'historique...</p></div>
            <div *ngIf="!paymentRequestsLoading && paymentRequests.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sujet</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Échéance</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let req of paymentRequests">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ req.sujet }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ req.montant | currency:'EUR' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ req.date_echeance | date:'dd/MM/yyyy' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" [ngClass]="{
                        'bg-green-100 text-green-800': req.statut === 'paid',
                        'bg-red-100 text-red-800': req.statut === 'failed' || req.statut === 'overdue',
                        'bg-yellow-100 text-yellow-800': req.statut === 'pending',
                        'bg-gray-100 text-gray-800': req.statut === 'cancelled'
                      }">{{ req.statut | paymentStatus }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <!-- Bouton pour initier le paiement -->
                      <button *ngIf="req.statut === 'pending' || req.statut === 'overdue'" (click)="initiatePayment(req)" class="text-indigo-600 hover:text-indigo-900">Payer</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div *ngIf="!paymentRequestsLoading && paymentRequests.length === 0" class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg"><p>Aucune demande de paiement trouvée.</p></div>
          </div>
          
          <!-- Section du formulaire de paiement, visible uniquement si une demande est sélectionnée -->
          <div *ngIf="selectedPaymentRequest" class="mt-8 border-t pt-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">Régler la demande : "{{ selectedPaymentRequest.sujet }}"</h3>
            
            <!-- Résumé de la facture à payer -->
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex items-center justify-between mb-6">
              <div>
                <p class="font-semibold text-gray-700">{{ selectedPaymentRequest.sujet }}</p>
                <p class="text-sm text-gray-500">Échéance: {{ selectedPaymentRequest.date_echeance | date:'dd/MM/yyyy' }}</p>
              </div>
              <div class="text-right">
                <p class="text-lg font-bold text-gray-800">{{ selectedPaymentRequest.montant | currency:'EUR' }}</p>
              </div>
            </div>

            <!-- Formulaire de paiement Stripe Elements -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Informations de la carte de crédit</label>
              <ngx-stripe-card [options]="cardOptions" [elementsOptions]="elementsOptions"></ngx-stripe-card>
            </div>

            <div class="flex items-center gap-4 mt-4">
              <button (click)="payWithStripe()" [disabled]="paymentLoading" class="flex-grow px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                {{ paymentLoading ? 'Paiement en cours...' : 'Payer ' + (selectedPaymentRequest.montant | currency:'EUR') }}
              </button>
              <button (click)="cancelPayment()" [disabled]="paymentLoading" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300">Annuler</button>
            </div>

            <!-- Message d'erreur -->
            <p *ngIf="paymentError" class="text-sm mt-2 font-medium text-red-600">{{ paymentError }}</p>
          </div>
          
          <!-- Pop-up de succès de paiement -->
          <div *ngIf="paymentSuccess" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50" id="my-modal">
            <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
              <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                  <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Paiement Réussi</h3>
                <div class="mt-2 px-7 py-3">
                  <p class="text-sm text-gray-500">{{ paymentSuccess }}</p>
                </div>
                <div class="items-center px-4 py-3">
                  <button (click)="closeSuccessPopup()" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                    Fermer
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>

  </div>
</div>
