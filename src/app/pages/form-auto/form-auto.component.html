<!-- Hero Section -->
<div class="relative isolate bg-black px-6 pt-14 lg:px-8" id="hero">
  <div class="mx-auto max-w-7xl py-8 sm:py-12 lg:py-16">
    <div class="grid grid-cols-1 items-center gap-x-8 gap-y-16 lg:grid-cols-2">
      <!-- Colonne de gauche : Texte -->
      <div class="text-center lg:text-left">
        <h1 class="text-4xl font-bold tracking-tight text-white sm:text-6xl">Assurance Auto</h1>
        <p class="mt-6 text-lg leading-8 text-gray-300">Souscrire une assurance auto, c’est rouler l’esprit tranquille ! Elle vous protège en cas d’accident et prend en charge les réparations de votre véhicule. Sans elle, les imprévus peuvent coûter très cher et entraîner des sanctions. Avec la bonne couverture, vous êtes serein sur la route et en sécurité, tout en protégeant les autres.</p>
        <div class="mt-10 flex items-center justify-center gap-x-6 lg:justify-start">
          <button (click)="scrollToSection('content')" class="rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm hover:bg-gray-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white">Souscrire</button>
          <a routerLink="/contact" class="text-sm font-semibold leading-6 text-white">Contact <span aria-hidden="true">→</span></a>
        </div>
      </div>
      <!-- Colonne de droite : Image -->
      <div class="flex justify-center lg:justify-end">
        <img src="https://fqopliwvpuiprdegxytz.supabase.co/storage/v1/object/sign/img_website/voiture.webp?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV81MmJmNDFiNC0yNGQ0LTQ3ZTktYmEzNi04YWZmY2NjMzEzNzIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJpbWdfd2Vic2l0ZS92b2l0dXJlLndlYnAiLCJpYXQiOjE3NjMwMjQ4MjIsImV4cCI6MjA3ODM4NDgyMn0.FImtkSpgJA8sH1jNbWWavhvpy0AvdxxDHeQtg9G40Cg" alt="Voiture rouge pour l'assurance auto" class="w-full max-w-xs rounded-xl shadow-xl ring-1 ring-gray-400/10 lg:max-w-md">
      </div>
    </div>
  </div>
</div>

<!-- Contenu de la page -->
<div id="content" class="container mx-auto p-4 py-16 sm:py-24">
  <div class="grid grid-cols-1 lg:grid-cols-2 lg:gap-12">
    <!-- Colonne de gauche pour le texte -->
    <div class="text-gray-700 prose lg:prose-lg max-w-none prose-h2:mb-4 prose-p:mt-4 prose-ul:mt-4">
      <h2 class="text-2xl font-bold">Assurances Auto</h2>
      <p>La loi stipule que tout propriétaire d’un véhicule à moteur doit contracter une assurance auto. Oui, mais laquelle ? Il existe en effet plusieurs niveaux de protection. Tout dépend donc de votre budget et de vos besoins concernant la qualité de la couverture.</p>
      <p>Voici les formules les plus répandues :</p>
      <ul>
        <li><strong>La RC obligatoire (aussi appelée assurance responsabilité civile auto) :</strong> c’est le minimum légal autorisé, puisqu’elle couvre uniquement les dommages (matériels et physiques) causés à autrui, lorsque le conducteur est considéré comme responsable.</li>
        <li><strong>La mini omnium propose une couverture au tiers améliorée.</strong> Elle est modulable et les garanties proposées varient d’un assureur à l’autre (bris de glace, incendie, vol).</li>
        <li><strong>La full omnium offre un haut niveau de garantie,</strong> non seulement pour le conducteur mais aussi pour le véhicule. Les indemnisations en cas de sinistre sont également plus rapides et interviennent sans attendre que le litige soit réglé avec l’autre assureur.</li>
        <li><strong>Omnium 24+ :</strong> il s’agit de la formule omnium adaptée aux voitures d’occasion.</li>
        <li><strong>Protection juridique :</strong> elle est toujours utile pour éviter tout conflit d’intérêt avec un tiers, un expert, une compagnie adverse…</li>
      </ul>
      <p>De plus, un certain nombre d’options permettent de moduler encore chaque formule : niveau de franchise, dommages couverts, âge du conducteur, assistance et services annexes, protection conducteur, etc.</p>
      <p>Bref, vous l’aurez compris, choisir l’assurance auto qui vous convient n’est pas si simple ! Mieux vaut consulter un courtier indépendant qui vous proposera une protection personnalisée.</p>
    </div>

    <!-- Popup de statut de soumission -->
    <div *ngIf="submissionStatus" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center" id="submission-popup">
      <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <!-- Icône -->
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full" [ngClass]="{'bg-green-100': submissionStatus.success, 'bg-red-100': !submissionStatus.success}">
            <svg *ngIf="submissionStatus.success" class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            <svg *ngIf="!submissionStatus.success" class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </div>
          <!-- Titre -->
          <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">
            {{ submissionStatus.success ? 'Opération réussie' : 'Une erreur est survenue' }}
          </h3>
          <!-- Message -->
          <div class="mt-2 px-7 py-3">
            <div class="text-sm text-gray-500 text-left" [innerHTML]="submissionStatus.message"></div>
          </div>
          <!-- Bouton -->
          <div class="items-center px-4 py-3">
            <button (click)="closePopup()" id="close-popup-btn" class="px-4 py-2 rounded-md text-white text-base font-medium shadow-sm w-full"
                    [ngClass]="{'bg-green-600 hover:bg-green-700 focus:ring-green-500': submissionStatus.success, 'bg-red-600 hover:bg-red-700 focus:ring-red-500': !submissionStatus.success}"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loader de soumission -->
    <div *ngIf="isSubmitting" class="fixed inset-0 bg-gray-800 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex flex-col items-center justify-center">
      <!-- Spinner -->
      <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <!-- Texte -->
      <p class="text-white text-lg font-semibold">Vérification de vos données...</p>
    </div>

    <!-- Colonne de droite pour le formulaire -->
    <form id="form" [formGroup]="autoForm" (ngSubmit)="onSubmit()" class="space-y-12 bg-white p-8 rounded-lg shadow-md mt-8 lg:mt-0">

      <!-- Section Preneur d'Assurance -->
      <fieldset class="border-t pt-6" formGroupName="preneur">
        <legend class="text-xl font-semibold px-2 text-gray-700 mb-4">1. Preneur d'assurance</legend>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div>
          <label for="preneur-genre" class="block text-sm font-medium text-gray-700">Genre</label>
          <select id="preneur-genre" formControlName="genre" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.genre')?.invalid && autoForm.get('preneur.genre')?.touched}">
            <option>Madame</option>
            <option>Monsieur</option>
            <option>Autre</option>
          </select>
        </div>
        <div>
          <label for="preneur-nom" class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="preneur-nom" formControlName="nom" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.nom')?.invalid && autoForm.get('preneur.nom')?.touched}">
        </div>
        <div>
          <label for="preneur-prenom" class="block text-sm font-medium text-gray-700">Prénom</label>
          <input type="text" id="preneur-prenom" formControlName="prenom" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.prenom')?.invalid && autoForm.get('preneur.prenom')?.touched}">
        </div>
        <div>
          <label for="preneur-dob" class="block text-sm font-medium text-gray-700">Date de naissance</label>
          <input type="date" id="preneur-dob" formControlName="date_naissance" [max]="maxDate" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.date_naissance')?.invalid && autoForm.get('preneur.date_naissance')?.touched}">
          <div *ngIf="autoForm.get('preneur.date_naissance')?.invalid && (autoForm.get('preneur.date_naissance')?.touched || autoForm.get('preneur.date_naissance')?.dirty)" class="text-red-600 text-sm mt-1">
            <div *ngIf="autoForm.get('preneur.date_naissance')?.hasError('required')">
              La date de naissance est requise.
            </div>
            <div *ngIf="autoForm.get('preneur.date_naissance')?.hasError('minAge')">
              L'âge minimum requis est de 14 ans.
            </div>
          </div>
        </div>
        <div>
          <label for="preneur-tel" class="block text-sm font-medium text-gray-700">Numéro de téléphone</label>
          <input type="tel" id="preneur-tel" formControlName="telephone" appPhoneFormat placeholder="+32 4XX XX XX XX" maxlength="18" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.telephone')?.invalid && autoForm.get('preneur.telephone')?.touched}">
        </div>
        <div>
          <label for="preneur-email" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="preneur-email" formControlName="email" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.email')?.invalid && autoForm.get('preneur.email')?.touched}">
          <div *ngIf="autoForm.get('preneur.email')?.hasError('email') && !autoForm.get('preneur.email')?.hasError('required')" class="text-red-600 text-sm mt-1">
            Le format de l'adresse email est invalide.
          </div>
        </div>
        <div class="lg:col-span-2">
          <label for="preneur-adresse" class="block text-sm font-medium text-gray-700">Rue et numéro</label>
          <input type="text" id="preneur-adresse" formControlName="adresse" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.adresse')?.invalid && autoForm.get('preneur.adresse')?.touched}">
        </div>
        <div>
          <div class="relative">
            <label for="preneur-cp" class="block text-sm font-medium text-gray-700">Code Postal</label>
            <input type="text" id="preneur-cp" formControlName="code_postal" autocomplete="off" maxlength="4" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 pl-3 pr-10 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.code_postal')?.invalid && autoForm.get('preneur.code_postal')?.touched}">
            <div *ngIf="isLoading" class="absolute inset-y-0 right-0 flex items-center pr-3">
              <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <ul *ngIf="filteredPreneurPostalCodes.length > 0" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto">
              <li *ngFor="let pc of filteredPreneurPostalCodes" (click)="selectPostalCode(pc, 'preneur')" class="px-3 py-2 cursor-pointer hover:bg-gray-100">
                {{ pc.postalCode }} - {{ pc.city }}
              </li>
            </ul>
          </div>
        </div>
        <div>
          <label for="preneur-ville" class="block text-sm font-medium text-gray-700">Ville</label>
          <select id="preneur-ville" formControlName="ville" [disabled]="preneurCities.length === 0" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm disabled:bg-gray-100" [ngClass]="{'ring-red-500': autoForm.get('preneur.ville')?.invalid && autoForm.get('preneur.ville')?.touched}">
            <option *ngIf="preneurCities.length === 0" value="">Ville</option>
            <option *ngFor="let city of preneurCities" [value]="city">
              {{ city }}
            </option>
          </select>
        </div>
        <div>
          <label for="preneur-permis" class="block text-sm font-medium text-gray-700">Numéro de permis de conduire</label>
          <input type="text" id="preneur-permis" formControlName="permis_numero" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.permis_numero')?.invalid && autoForm.get('preneur.permis_numero')?.touched}">
          <div *ngIf="autoForm.get('preneur.permis_numero')?.hasError('permisExists')" class="text-orange-800 bg-orange-100 p-2 rounded-md text-sm mt-2">
            Attention : ce numéro de permis est déjà enregistré dans notre système.
          </div>
        </div>
        <div>
          <label for="preneur-permis-date" class="block text-sm font-medium text-gray-700">Date d'obtention du permis</label>
          <input type="date" id="preneur-permis-date" formControlName="permis_date" [max]="maxDate" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('preneur.permis_date')?.invalid && autoForm.get('preneur.permis_date')?.touched}">
          <div *ngIf="autoForm.get('preneur.permis_date')?.invalid && (autoForm.get('preneur.permis_date')?.touched || autoForm.get('preneur.permis_date')?.dirty)" class="text-red-600 text-sm mt-1">
            <div *ngIf="autoForm.get('preneur.permis_date')?.hasError('dateNotInPast')">
              La date doit être antérieure à aujourd'hui.
            </div>
            <div *ngIf="autoForm.get('preneur')?.hasError('datePermisTropTot') && autoForm.get('preneur.permis_date')?.touched">
              La date d'obtention du permis doit être au moins 14 ans après la date de naissance.
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <!-- Section Conducteur -->
    <fieldset class="border-t pt-6">
      <legend class="text-xl font-semibold px-2 text-gray-700 mb-4">2. Conducteur principal (si différent)</legend>
      <div class="flex items-center mb-4">
        <input id="conducteur-diff" formControlName="conducteurDifferent" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
        <label for="conducteur-diff" class="ml-2 block text-sm text-gray-900">Le conducteur principal est différent du preneur d'assurance.</label>
      </div>

      <!-- Champs pour le conducteur différent, à afficher conditionnellement -->
      <div *ngIf="autoForm.get('conducteurDifferent')?.value" formGroupName="conducteur" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div>
          <label for="conducteur-genre" class="block text-sm font-medium text-gray-700">Genre</label>
          <select id="conducteur-genre" formControlName="genre" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('conducteur.genre')?.invalid && autoForm.get('conducteur.genre')?.touched}">
            <option>Madame</option>
            <option>Monsieur</option>
            <option>Autre</option>
          </select>
        </div>
        <div>
          <label for="conducteur-nom" class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="conducteur-nom" formControlName="nom" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('conducteur.nom')?.invalid && autoForm.get('conducteur.nom')?.touched}">
        </div>
        <div>
          <label for="conducteur-prenom" class="block text-sm font-medium text-gray-700">Prénom</label>
          <input type="text" id="conducteur-prenom" formControlName="prenom" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('conducteur.prenom')?.invalid && autoForm.get('conducteur.prenom')?.touched}">
        </div>
        <div>
          <label for="conducteur-dob" class="block text-sm font-medium text-gray-700">Date de naissance</label>
          <input type="date" id="conducteur-dob" formControlName="date_naissance" [max]="maxDate" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('conducteur.date_naissance')?.invalid && autoForm.get('conducteur.date_naissance')?.touched}">
          <div *ngIf="autoForm.get('conducteur.date_naissance')?.invalid && (autoForm.get('conducteur.date_naissance')?.touched || autoForm.get('conducteur.date_naissance')?.dirty)" class="text-red-600 text-sm mt-1">
            <div *ngIf="autoForm.get('conducteur.date_naissance')?.hasError('required')">
              La date de naissance est requise.
            </div>
            <div *ngIf="autoForm.get('conducteur.date_naissance')?.hasError('minAge')">
              L'âge minimum requis est de 14 ans.
            </div>
          </div>
        </div>
        <div class="lg:col-span-2">
          <label for="conducteur-adresse" class="block text-sm font-medium text-gray-700">Rue et numéro</label>
          <input type="text" id="conducteur-adresse" formControlName="adresse" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('conducteur.adresse')?.invalid && autoForm.get('conducteur.adresse')?.touched}">
        </div>
        <div>
          <div class="relative">
            <label for="conducteur-cp" class="block text-sm font-medium text-gray-700">Code Postal</label>
            <input type="text" id="conducteur-cp" formControlName="code_postal" autocomplete="off" maxlength="4" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 pl-3 pr-10 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('conducteur.code_postal')?.invalid && autoForm.get('conducteur.code_postal')?.touched}">
            <div *ngIf="isLoading" class="absolute inset-y-0 right-0 flex items-center pr-3">
              <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <ul *ngIf="filteredConducteurPostalCodes.length > 0" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto">
              <li *ngFor="let pc of filteredConducteurPostalCodes" (click)="selectPostalCode(pc, 'conducteur')" class="px-3 py-2 cursor-pointer hover:bg-gray-100">
                {{ pc.postalCode }} - {{ pc.city }}
              </li>
            </ul>
          </div>
        </div>
        <div>
          <label for="conducteur-ville" class="block text-sm font-medium text-gray-700">Ville</label>
          <select id="conducteur-ville" formControlName="ville" [disabled]="conducteurCities.length === 0" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm disabled:bg-gray-100" [ngClass]="{'ring-red-500': autoForm.get('conducteur.ville')?.invalid && autoForm.get('conducteur.ville')?.touched}">
            <option *ngIf="conducteurCities.length === 0" value="">Ville</option>
            <option *ngFor="let city of conducteurCities" [value]="city">
              {{ city }}
            </option>
          </select>
        </div>
        <div>
          <label for="conducteur-permis" class="block text-sm font-medium text-gray-700">Numéro de permis de conduire</label>
          <input type="text" id="conducteur-permis" formControlName="permis_numero" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('conducteur.permis_numero')?.invalid && autoForm.get('conducteur.permis_numero')?.touched}">
          <div *ngIf="autoForm.get('conducteur.permis_numero')?.hasError('permisExists')" class="text-orange-800 bg-orange-100 p-2 rounded-md text-sm mt-2">
            Attention : ce numéro de permis est déjà enregistré dans notre système.
          </div>
        </div>
        <div>
          <label for="conducteur-permis-date" class="block text-sm font-medium text-gray-700">Date d'obtention du permis</label>
          <input type="date" id="conducteur-permis-date" formControlName="permis_date" [max]="maxDate" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('conducteur.permis_date')?.invalid && autoForm.get('conducteur.permis_date')?.touched}">
          <div *ngIf="autoForm.get('conducteur.permis_date')?.invalid && (autoForm.get('conducteur.permis_date')?.touched || autoForm.get('conducteur.permis_date')?.dirty)" class="text-red-600 text-sm mt-1">
            <div *ngIf="autoForm.get('conducteur.permis_date')?.hasError('dateNotInPast')">
              La date doit être antérieure à aujourd'hui.
            </div>
            <div *ngIf="autoForm.get('conducteur')?.hasError('datePermisTropTot') && autoForm.get('conducteur.permis_date')?.touched">
              La date d'obtention du permis doit être au moins 14 ans après la date de naissance.
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <!-- Section Véhicule -->
    <fieldset class="border-t pt-6" formGroupName="vehicule">
      <legend class="text-xl font-semibold px-2 text-gray-700 mb-4">3. Informations sur le véhicule</legend>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div>
          <label for="vehicule-type" class="block text-sm font-medium text-gray-700">Type de véhicule</label>
          <select id="vehicule-type" formControlName="type" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('vehicule.type')?.invalid && autoForm.get('vehicule.type')?.touched}">
            <option value="" disabled>Sélectionnez un type</option>
            <option value="Voiture">Voiture</option>
            <option value="Camionnette">Camionnette</option>
            <option value="Camion">Camion</option>
            <option value="Bus">Bus</option>
            <option value="Mini Bus">Mini Bus</option>
            <option value="Voiture sans permis">Voiture sans permis</option>
            <option value="Moto">Moto</option>
            <option value="Cyclomoteur">Cyclomoteur</option>
            <option value="Trottinette">Trottinette</option>
          </select>
        </div>
        <div>
          <div class="relative">
            <label for="vehicule-marque" class="block text-sm font-medium text-gray-700">Marque</label>
            <input type="text" id="vehicule-marque" formControlName="marque" (input)="onMarqueInput($event)" autocomplete="off" placeholder="Ex: Volkswagen" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('vehicule.marque')?.invalid && autoForm.get('vehicule.marque')?.touched}">
            <div *ngIf="isMarqueLoading" class="absolute inset-y-0 right-0 flex items-center pr-3 top-6">
              <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            </div>
            <ul *ngIf="filteredMarques.length > 0" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto">
              <li *ngFor="let m of filteredMarques" (click)="selectMarque(m)" class="px-3 py-2 cursor-pointer hover:bg-gray-100">
                {{ m.nom }}
              </li>
            </ul>
          </div>
        </div>
        <div>
          <div class="relative">
            <label for="vehicule-modele" class="block text-sm font-medium text-gray-700">Modèle</label>
            <!-- Champ d'input qui affiche le modèle sélectionné et gère la validation visuelle -->
            <input type="text" id="vehicule-modele" formControlName="modele" readonly (click)="toggleModeleList()"
                   [placeholder]="!selectedMarque ? 'Sélectionnez une marque' : (isModeleLoading ? 'Chargement...' : 'Cliquez pour choisir un modèle')"
                   class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm cursor-pointer"
                   [ngClass]="{'ring-red-500': autoForm.get('vehicule.modele')?.invalid && autoForm.get('vehicule.modele')?.touched, 'cursor-not-allowed': !selectedMarque}">

            <div *ngIf="isModeleLoading" class="absolute inset-y-0 right-0 flex items-center pr-3 top-6">
              <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            </div>
            <!-- Liste déroulante pour la sélection -->
            <ul *ngIf="showModeleList && filteredModeles.length > 0" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto">
              <li *ngFor="let mdl of filteredModeles" (click)="selectModele(mdl)" class="px-3 py-2 cursor-pointer hover:bg-gray-100">
                {{ mdl.nom }}
              </li>
            </ul>
          </div>
        </div>
        <div>
          <label for="vehicule-puissance" class="block text-sm font-medium text-gray-700">Puissance (kW)</label>
          <input type="number" id="vehicule-puissance" formControlName="puissance" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('vehicule.puissance')?.invalid && autoForm.get('vehicule.puissance')?.touched}">
        </div>
        <div>
          <label for="vehicule-places" class="block text-sm font-medium text-gray-700">Nombre de places (conducteur inclus)</label>
          <input type="number" id="vehicule-places" formControlName="places" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('vehicule.places')?.invalid && autoForm.get('vehicule.places')?.touched}">
        </div>
        <div>
          <label for="vehicule-circu-date" class="block text-sm font-medium text-gray-700">Date de 1ère mise en circulation</label>
          <input type="date" id="vehicule-circu-date" formControlName="dateCirculation" [max]="maxDate" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('vehicule.dateCirculation')?.invalid && autoForm.get('vehicule.dateCirculation')?.touched}">
          <div *ngIf="autoForm.get('vehicule.dateCirculation')?.invalid && (autoForm.get('vehicule.dateCirculation')?.touched || autoForm.get('vehicule.dateCirculation')?.dirty)" class="text-red-600 text-sm mt-1">
            <div *ngIf="autoForm.get('vehicule.dateCirculation')?.hasError('dateNotInPast')">
              La date doit être antérieure à aujourd'hui.
            </div>
          </div>
        </div>
        <div>
          <label for="vehicule-valeur" class="block text-sm font-medium text-gray-700">Valeur catalogue/facture (si Omnium)</label>
          <input type="number" id="vehicule-valeur" formControlName="valeur" placeholder="€" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm">
        </div>
      </div>
    </fieldset>

    <!-- Section Garanties -->
    <fieldset class="border-t pt-6" formGroupName="garanties">
      <legend class="text-xl font-semibold px-2 text-gray-700 mb-4">4. Garanties souhaitées</legend>
      <div class="space-y-4">
        <div class="flex items-start">
          <div class="flex h-5 items-center">
            <input id="garantie-base" formControlName="base" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
          </div>
          <div class="ml-3 text-sm">
            <label for="garantie-base" class="font-medium text-gray-700">Garantie de base (Responsabilité Civile + Protection Juridique)</label>
          </div>
        </div>
        <div>
          <label class="text-base font-medium text-gray-900">Omnium</label>
          <fieldset class="mt-2"> <!-- Pas de formGroupName ici car les radios partagent le même formControlName -->
            <div class="space-y-2 sm:flex sm:items-center sm:space-y-0 sm:space-x-10">
              <div class="flex items-center">
                <input id="omnium-non" formControlName="omnium" value="non" type="radio" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="omnium-non" class="ml-3 block text-sm font-medium text-gray-700">Non souhaitée</label>
              </div>
              <div class="flex items-center">
                <input id="omnium-partiel" formControlName="omnium" value="partiel" type="radio" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="omnium-partiel" class="ml-3 block text-sm font-medium text-gray-700">Omnium Partielle</label>
              </div>
              <div class="flex items-center">
                <input id="omnium-total" formControlName="omnium" value="total" type="radio" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="omnium-total" class="ml-3 block text-sm font-medium text-gray-700">Omnium Totale</label>
              </div>
            </div>
          </fieldset>
        </div>
        <div class="flex items-start">
          <div class="flex h-5 items-center">
            <input id="garantie-conducteur" formControlName="conducteur" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
          </div>
          <div class="ml-3 text-sm">
            <label for="garantie-conducteur" class="font-medium text-gray-700">Assurance Conducteur</label>
          </div>
        </div>
        <div class="flex items-start">
          <div class="flex h-5 items-center">
            <input id="garantie-assistance" formControlName="assistance" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
          </div>
          <div class="ml-3 text-sm">
            <label for="garantie-assistance" class="font-medium text-gray-700">Assistance</label>
          </div>
        </div>
      </div>
    </fieldset>

    <div class="pt-4 border-t">
      <label for="date-effet" class="block text-sm font-medium text-gray-700">Date d'effet souhaitée</label>
      <input type="date" id="date-effet" formControlName="dateEffet" [min]="minDate" class="mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none w-full text-sm leading-6 text-slate-900 placeholder-slate-400 rounded-md py-2 px-3 ring-1 ring-slate-200 shadow-sm" [ngClass]="{'ring-red-500': autoForm.get('dateEffet')?.invalid && autoForm.get('dateEffet')?.touched}">
    </div>

    <!-- Message pour email existant -->
    <div *ngIf="autoForm.get('preneur.email')?.hasError('emailExists') && autoForm.get('preneur.email')?.touched" class="text-green-800 bg-green-100 p-3 rounded-md text-sm mt-4 text-center">
      <p>
        Bonne nouvelle ! Cet email est déjà connu chez nous.
        <a routerLink="/account" class="font-bold underline hover:text-green-700">Connectez-vous</a>
        pour récupérer vos données et accélérer votre demande.
      </p>
    </div>

    <!-- Bouton de soumission -->
    <div class="pt-6">
      <div class="flex justify-end">
        <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
          Recevoir mon offre
        </button>
      </div>
    </div>

    </form>
  </div>
</div>
