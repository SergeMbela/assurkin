"use strict";(self.webpackChunkassurkin=self.webpackChunkassurkin||[]).push([[659],{2659:(le,f,u)=>{u.r(f),u.d(f,{MessagerieComponent:()=>se});var p=u(467),e=u(4438),d=u(177),h=u(9981),a=u(9417),y=u(8141),E=u(5558),b=u(5312),F=u(4125),k=u(3161),j=u(1807),M=u(8212),D=u(8072);const C=()=>["/management"],w=(n,i,t)=>({"bg-green-100 text-green-800":n,"bg-yellow-100 text-yellow-800":i,"bg-red-100 text-red-800":t}),R=(n,i)=>({"bg-green-100 text-green-800":n,"bg-gray-100 text-gray-800":i});function $(n,i){if(1&n&&(e.j41(0,"div",19),e.EFF(1),e.k0s()),2&n){const t=e.XpG();e.R7$(),e.SpI(" ",t.successMessage," ")}}function I(n,i){if(1&n&&(e.j41(0,"div",20),e.EFF(1),e.k0s()),2&n){const t=e.XpG();e.R7$(),e.SpI(" ",t.warningMessage," ")}}function T(n,i){if(1&n&&(e.j41(0,"div",21),e.EFF(1),e.k0s()),2&n){const t=e.XpG();e.R7$(),e.SpI(" ",t.errorMessage," ")}}function S(n,i){1&n&&(e.qSk(),e.j41(0,"svg",32),e.nrm(1,"circle",33)(2,"path",34),e.k0s())}function q(n,i){if(1&n){const t=e.RV6();e.j41(0,"div")(1,"form",22),e.bIt("ngSubmit",function(){e.eBV(t);const s=e.XpG();return e.Njj(s.sendSms())}),e.j41(2,"div",23)(3,"label",24),e.EFF(4,"Destinataire (t\xe9l\xe9phone)"),e.k0s(),e.nrm(5,"input",25),e.k0s(),e.j41(6,"div",23)(7,"label",26),e.EFF(8,"Message"),e.k0s(),e.nrm(9,"textarea",27),e.j41(10,"div",28),e.EFF(11),e.k0s()(),e.j41(12,"div",29)(13,"button",30),e.DNE(14,S,3,0,"svg",31),e.EFF(15),e.k0s()()()()}if(2&n){let t;const o=e.XpG();e.R7$(),e.Y8G("formGroup",o.smsForm),e.R7$(10),e.SpI(" ",(null==(t=o.smsForm.get("message"))||null==t.value?null:t.value.length)||0," / 160 caract\xe8res "),e.R7$(2),e.Y8G("disabled",o.smsForm.invalid||o.loading),e.R7$(),e.Y8G("ngIf",o.loading),e.R7$(),e.SpI(" ",o.loading?"Envoi en cours...":"Envoyer le SMS"," ")}}function G(n,i){1&n&&(e.qSk(),e.j41(0,"svg",32),e.nrm(1,"circle",33)(2,"path",34),e.k0s())}function P(n,i){if(1&n){const t=e.RV6();e.j41(0,"div")(1,"form",22),e.bIt("ngSubmit",function(){e.eBV(t);const s=e.XpG();return e.Njj(s.sendEmail())}),e.j41(2,"div",23)(3,"label",35),e.EFF(4,"Destinataire (email)"),e.k0s(),e.nrm(5,"input",36),e.k0s(),e.j41(6,"div",23)(7,"label",37),e.EFF(8,"Sujet"),e.k0s(),e.nrm(9,"input",38),e.k0s(),e.j41(10,"div",23)(11,"label",39),e.EFF(12,"Contenu de l'e-mail"),e.k0s(),e.nrm(13,"textarea",40),e.k0s(),e.j41(14,"div",29)(15,"button",30),e.DNE(16,G,3,0,"svg",31),e.EFF(17),e.k0s()()()()}if(2&n){const t=e.XpG();e.R7$(),e.Y8G("formGroup",t.emailForm),e.R7$(14),e.Y8G("disabled",t.emailForm.invalid||t.loading),e.R7$(),e.Y8G("ngIf",t.loading),e.R7$(),e.SpI(" ",t.loading?"Envoi en cours...":"Envoyer l'e-mail"," ")}}function A(n,i){if(1&n&&(e.j41(0,"option",68),e.EFF(1),e.k0s()),2&n){const t=i.$implicit;e.Y8G("value",t.value),e.R7$(),e.JRh(t.label)}}function Y(n,i){1&n&&(e.j41(0,"div",69),e.EFF(1,"Le sujet est requis."),e.k0s())}function L(n,i){1&n&&(e.j41(0,"div",69),e.EFF(1,"Le montant est requis."),e.k0s())}function N(n,i){1&n&&(e.j41(0,"div",69),e.EFF(1,"Le montant doit \xeatre positif."),e.k0s())}function V(n,i){1&n&&(e.j41(0,"div",69),e.EFF(1,"La date d'\xe9ch\xe9ance est requise."),e.k0s())}function O(n,i){1&n&&(e.j41(0,"div",69),e.EFF(1,"La date d'\xe9ch\xe9ance ne peut pas \xeatre dans le pass\xe9."),e.k0s())}function U(n,i){1&n&&(e.qSk(),e.j41(0,"svg",32),e.nrm(1,"circle",33)(2,"path",34),e.k0s())}function B(n,i){if(1&n){const t=e.RV6();e.j41(0,"button",76),e.bIt("click",function(){e.eBV(t);const s=e.XpG().$implicit,r=e.XpG(2);return e.Njj(r.downloadInvoice(s))}),e.qSk(),e.j41(1,"svg",77),e.nrm(2,"path",78),e.k0s(),e.EFF(3," PDF "),e.k0s()}}function X(n,i){if(1&n){const t=e.RV6();e.j41(0,"button",79),e.bIt("click",function(){e.eBV(t);const s=e.XpG().$implicit,r=e.XpG(2);return e.Njj(r.retryInvoice(s))}),e.qSk(),e.j41(1,"svg",77),e.nrm(2,"path",80),e.k0s(),e.EFF(3," R\xe9essayer "),e.k0s()}}function W(n,i){if(1&n&&(e.j41(0,"tr")(1,"td",70),e.EFF(2),e.nI1(3,"date"),e.k0s(),e.j41(4,"td",71),e.EFF(5),e.k0s(),e.j41(6,"td",71),e.EFF(7),e.nI1(8,"currency"),e.k0s(),e.j41(9,"td",72)(10,"span",73),e.EFF(11),e.k0s()(),e.j41(12,"td",70)(13,"span",73),e.EFF(14),e.k0s()(),e.j41(15,"td",70),e.DNE(16,B,4,0,"button",74)(17,X,4,0,"button",75),e.k0s()()),2&n){const t=i.$implicit;e.R7$(2),e.JRh(e.i5U(3,9,t.created_at,"dd/MM/yyyy HH:mm")),e.R7$(3),e.JRh(t.sujet),e.R7$(2),e.JRh(e.ii3(8,12,t.montant,"EUR","symbol","1.2-2")),e.R7$(3),e.Y8G("ngClass",e.sMw(17,w,"paid"===t.statut,"pending"===t.statut,"failed"===t.statut)),e.R7$(),e.SpI(" ","pending"===t.statut?"En attente":"paid"===t.statut?"Pay\xe9":t.statut," "),e.R7$(2),e.Y8G("ngClass",e.l_i(21,R,t.storecove_invoice_id,!t.storecove_invoice_id)),e.R7$(),e.SpI(" ",t.storecove_invoice_id?"Envoy\xe9e":"Non envoy\xe9e"," "),e.R7$(2),e.Y8G("ngIf",t.storecove_invoice_id),e.R7$(),e.Y8G("ngIf",!t.storecove_invoice_id)}}function z(n,i){1&n&&(e.j41(0,"tr")(1,"td",81),e.EFF(2,"Aucun paiement trouv\xe9."),e.k0s()())}function H(n,i){if(1&n){const t=e.RV6();e.j41(0,"div")(1,"form",22),e.bIt("ngSubmit",function(){e.eBV(t);const s=e.XpG();return e.Njj(s.sendPaymentRequest())}),e.j41(2,"div",41)(3,"div",23)(4,"label",42),e.EFF(5,"Sujet de la demande"),e.k0s(),e.j41(6,"select",43)(7,"option",44),e.EFF(8,"S\xe9lectionnez un sujet"),e.k0s(),e.DNE(9,A,2,2,"option",45),e.k0s(),e.DNE(10,Y,2,0,"div",46),e.k0s(),e.j41(11,"div",23)(12,"label",47),e.EFF(13,"Montant"),e.k0s(),e.j41(14,"div",48),e.nrm(15,"input",49),e.j41(16,"div",50)(17,"span",51),e.EFF(18,"EUR"),e.k0s()()(),e.DNE(19,L,2,0,"div",46)(20,N,2,0,"div",46),e.k0s()(),e.j41(21,"div",23)(22,"label",52),e.EFF(23,"Date d'\xe9ch\xe9ance"),e.k0s(),e.nrm(24,"input",53),e.DNE(25,V,2,0,"div",46)(26,O,2,0,"div",46),e.k0s(),e.j41(27,"div",54)(28,"label",55),e.EFF(29,"Remarques (optionnel)"),e.k0s(),e.nrm(30,"textarea",56),e.k0s(),e.j41(31,"div",29)(32,"button",30),e.DNE(33,U,3,0,"svg",31),e.EFF(34),e.k0s()()(),e.j41(35,"div",57)(36,"h3",58),e.EFF(37,"Historique des paiements"),e.k0s(),e.j41(38,"div",59)(39,"div",60)(40,"div",61)(41,"div",62)(42,"table",63)(43,"thead",64)(44,"tr")(45,"th",65),e.EFF(46,"Date"),e.k0s(),e.j41(47,"th",65),e.EFF(48,"Sujet"),e.k0s(),e.j41(49,"th",65),e.EFF(50,"Montant"),e.k0s(),e.j41(51,"th",65),e.EFF(52,"Statut"),e.k0s(),e.j41(53,"th",65),e.EFF(54,"Statut Facture"),e.k0s(),e.j41(55,"th",65),e.EFF(56,"Facture"),e.k0s()()(),e.j41(57,"tbody",66),e.DNE(58,W,18,24,"tr",67)(59,z,3,0,"tr",18),e.k0s()()()()()()()()}if(2&n){let t,o,s,r,m;const l=e.XpG();e.R7$(),e.Y8G("formGroup",l.paymentForm),e.R7$(8),e.Y8G("ngForOf",l.paymentSubjects),e.R7$(),e.Y8G("ngIf",(null==(t=l.paymentForm.get("sujet"))?null:t.touched)&&(null==(t=l.paymentForm.get("sujet"))?null:t.hasError("required"))),e.R7$(9),e.Y8G("ngIf",(null==(o=l.paymentForm.get("montant"))?null:o.touched)&&(null==(o=l.paymentForm.get("montant"))?null:o.hasError("required"))),e.R7$(),e.Y8G("ngIf",(null==(s=l.paymentForm.get("montant"))?null:s.touched)&&(null==(s=l.paymentForm.get("montant"))?null:s.hasError("min"))),e.R7$(5),e.Y8G("ngIf",(null==(r=l.paymentForm.get("dateEcheance"))?null:r.touched)&&(null==(r=l.paymentForm.get("dateEcheance"))?null:r.hasError("required"))),e.R7$(),e.Y8G("ngIf",(null==(m=l.paymentForm.get("dateEcheance"))?null:m.touched)&&(null==(m=l.paymentForm.get("dateEcheance"))?null:m.hasError("pastDate"))),e.R7$(6),e.Y8G("disabled",l.paymentForm.invalid||l.loading),e.R7$(),e.Y8G("ngIf",l.loading),e.R7$(),e.SpI(" ",l.loading?"Envoi en cours...":"Envoyer la demande de paiement"," "),e.R7$(24),e.Y8G("ngForOf",l.payments),e.R7$(),e.Y8G("ngIf",!l.payments||0===l.payments.length)}}function K(n,i){if(1&n&&(e.j41(0,"option",68),e.EFF(1),e.k0s()),2&n){const t=i.$implicit;e.Y8G("value",t.value),e.R7$(),e.JRh(t.label)}}function Q(n,i){1&n&&(e.j41(0,"div",69),e.EFF(1,"La cat\xe9gorie est requise."),e.k0s())}function J(n,i){1&n&&(e.j41(0,"div",69),e.EFF(1,"Le montant est requis."),e.k0s())}function Z(n,i){1&n&&(e.j41(0,"div",69),e.EFF(1,"La date d'\xe9ch\xe9ance est requise."),e.k0s())}function ee(n,i){if(1&n&&(e.j41(0,"option",68),e.EFF(1),e.k0s()),2&n){const t=i.$implicit;e.Y8G("value",t.nom),e.R7$(),e.JRh(t.nom)}}function te(n,i){1&n&&(e.qSk(),e.j41(0,"svg",32),e.nrm(1,"circle",33)(2,"path",34),e.k0s())}function ne(n,i){if(1&n){const t=e.RV6();e.j41(0,"div")(1,"form",22),e.bIt("ngSubmit",function(){e.eBV(t);const s=e.XpG();return e.Njj(s.saveCommission())}),e.j41(2,"div",41)(3,"div",23)(4,"label",82),e.EFF(5,"Cat\xe9gorie"),e.k0s(),e.j41(6,"select",83)(7,"option",44),e.EFF(8,"S\xe9lectionnez une cat\xe9gorie"),e.k0s(),e.DNE(9,K,2,2,"option",45),e.k0s(),e.DNE(10,Q,2,0,"div",46),e.k0s(),e.j41(11,"div",23)(12,"label",84),e.EFF(13,"Montant"),e.k0s(),e.j41(14,"div",48),e.nrm(15,"input",85),e.j41(16,"div",50)(17,"span",51),e.EFF(18,"EUR"),e.k0s()()(),e.DNE(19,J,2,0,"div",46),e.k0s(),e.j41(20,"div",23)(21,"label",86),e.EFF(22,"Date d'\xe9ch\xe9ance"),e.k0s(),e.nrm(23,"input",87),e.DNE(24,Z,2,0,"div",46),e.k0s(),e.j41(25,"div",23)(26,"label",88),e.EFF(27,"Date de paiement"),e.k0s(),e.nrm(28,"input",89),e.k0s(),e.j41(29,"div",90)(30,"label",91),e.EFF(31,"Compagnie d'assurance"),e.k0s(),e.j41(32,"select",92)(33,"option",44),e.EFF(34,"S\xe9lectionnez une compagnie"),e.k0s(),e.DNE(35,ee,2,2,"option",45),e.nI1(36,"async"),e.k0s()()(),e.j41(37,"div",93)(38,"button",30),e.DNE(39,te,3,0,"svg",31),e.EFF(40),e.k0s()()()()}if(2&n){let t,o,s;const r=e.XpG();e.R7$(),e.Y8G("formGroup",r.commissionForm),e.R7$(8),e.Y8G("ngForOf",r.commissionCategories),e.R7$(),e.Y8G("ngIf",(null==(t=r.commissionForm.get("categorie"))?null:t.touched)&&(null==(t=r.commissionForm.get("categorie"))?null:t.hasError("required"))),e.R7$(9),e.Y8G("ngIf",(null==(o=r.commissionForm.get("montant"))?null:o.touched)&&(null==(o=r.commissionForm.get("montant"))?null:o.hasError("required"))),e.R7$(5),e.Y8G("ngIf",(null==(s=r.commissionForm.get("dateEcheance"))?null:s.touched)&&(null==(s=r.commissionForm.get("dateEcheance"))?null:s.hasError("required"))),e.R7$(11),e.Y8G("ngForOf",e.bMT(36,9,r.insuranceCompanies$)),e.R7$(3),e.Y8G("disabled",r.commissionForm.invalid||r.loading),e.R7$(),e.Y8G("ngIf",r.loading),e.R7$(),e.SpI(" ",r.loading?"Enregistrement...":"Enregistrer"," ")}}let se=(()=>{class n{route=(0,e.WQX)(h.nX);fb=(0,e.WQX)(a.ok);smsService=(0,e.WQX)(F.T);mailService=(0,e.WQX)(k.t);dbService=(0,e.WQX)(j.y);paymentService=(0,e.WQX)(M.W);storecoveService=(0,e.WQX)(D.g);activeTab="sms";smsForm;emailForm;paymentForm;commissionForm;quoteId=null;quoteType=null;preneurDetails=null;currentUserUid=null;loading=!1;successMessage=null;warningMessage=null;errorMessage=null;payments=[];paymentSubjects=[{value:"acompte",label:"Acompte"},{value:"solde",label:"Solde du devis"},{value:"regularisation",label:"R\xe9gularisation"},{value:"autre",label:"Autre"}];commissionCategories=[{value:"commission_bancaire",label:"Commission bancaire"},{value:"frais_dossier",label:"Frais de dossier"},{value:"commission_assurance",label:"Commission d'assurance"}];insuranceCompanies$=null;ngOnInit(){this.smsForm=this.fb.group({to:["",[a.k0.required]],message:["",[a.k0.required,a.k0.maxLength(160)]]}),this.emailForm=this.fb.group({to:["",[a.k0.required,a.k0.email]],subject:["",[a.k0.required]],htmlContent:["",[a.k0.required]]}),this.paymentForm=this.fb.group({sujet:["",a.k0.required],montant:[null,[a.k0.required,a.k0.min(.01)]],dateEcheance:["",[a.k0.required,this.futureDateValidator]],remarques:[""]}),this.commissionForm=this.fb.group({categorie:["",a.k0.required],montant:[null,[a.k0.required,a.k0.min(.01)]],dateEcheance:["",a.k0.required],datePaiement:[""],compagnie:[""]}),this.insuranceCompanies$=this.dbService.getAllAssureurs(),this.route.paramMap.pipe((0,y.M)(t=>{this.quoteId=Number(t.get("id")),this.quoteType=t.get("type"),("commissions"===this.activeTab||"payment"===this.activeTab)&&this.loadPayments()}),(0,E.n)(()=>this.dbService.getFullQuoteDetails(this.quoteId))).subscribe(t=>{t&&t.preneur&&(console.log("D\xe9tails du preneur re\xe7us:",t.preneur),this.preneurDetails=t.preneur,this.smsForm.patchValue({to:this.preneurDetails?.telephone}),this.emailForm.patchValue({to:this.preneurDetails?.email}))}),this.dbService.getCurrentUser().subscribe(t=>{this.currentUserUid=t?.id??null})}setActiveTab(t){this.activeTab=t,this.resetMessages(),("commissions"===t||"payment"===t)&&this.loadPayments()}sendSms(){var t=this;if(this.smsForm.invalid)return;this.loading=!0,this.resetMessages();const{to:o,message:s}=this.smsForm.value;this.smsService.sendSms(o,s).then((0,p.A)(function*(){t.successMessage="SMS envoy\xe9 avec succ\xe8s !",yield t.saveMessageToDb("sms","sent",{recipient:o,content:s}),t.smsForm.get("message")?.reset()})).catch(function(){var r=(0,p.A)(function*(m){yield t.saveMessageToDb("sms","failed",{recipient:o,content:s,error:m.message}),t.errorMessage=m.message||"Une erreur est survenue lors de l'envoi du SMS."});return function(m){return r.apply(this,arguments)}}()).finally(()=>this.loading=!1)}sendEmail(){var t=this;if(this.emailForm.invalid)return;this.loading=!0,this.resetMessages();const o=this.emailForm.value;this.mailService.sendEmail(o).toPromise().then(function(){var s=(0,p.A)(function*(r){if(!r.ok){const m=yield r.json();throw new Error(m.error||`Erreur HTTP: ${r.status}`)}yield t.saveMessageToDb("email","sent",{recipient:o.to,subject:o.subject,content:o.htmlContent}),t.successMessage="E-mail envoy\xe9 avec succ\xe8s !",t.emailForm.get("subject")?.reset(),t.emailForm.get("htmlContent")?.reset()});return function(r){return s.apply(this,arguments)}}()).catch(function(){var s=(0,p.A)(function*(r){yield t.saveMessageToDb("email","failed",{recipient:o.to,subject:o.subject,content:o.htmlContent,error:r.message}),t.errorMessage=r.error?.error||"Une erreur est survenue lors de l'envoi de l'e-mail."});return function(r){return s.apply(this,arguments)}}()).finally(()=>this.loading=!1)}sendPaymentRequest(){var t=this;return(0,p.A)(function*(){if(t.paymentForm.invalid)return void t.paymentForm.markAllAsTouched();if(t.loading=!0,t.resetMessages(),!t.preneurDetails?.telephone||!t.preneurDetails?.email||!t.preneurDetails?.id)return t.errorMessage="Les d\xe9tails du preneur (ID, t\xe9l\xe9phone, e-mail) sont incomplets.",void(t.loading=!1);const{sujet:o,montant:s,dateEcheance:r,remarques:m}=t.paymentForm.value,l=t.paymentSubjects.find(c=>c.value===o)?.label||o;try{const c=yield t.paymentService.createPaymentRequest({quote_id:t.quoteId,quote_type:t.quoteType,montant:s,sujet:l,remarques:m,date_echeance:r,uid_user:t.currentUserUid??void 0});t.storecoveService.createInvoice({paymentRequestId:c.id,customer:{id:t.preneurDetails.id,name:`${t.preneurDetails.prenom} ${t.preneurDetails.nom}`,email:t.preneurDetails.email,address:t.preneurDetails.adresse,postalCode:t.preneurDetails.code_postal,city:t.preneurDetails.ville},invoiceDetails:{amount:s,description:l,dueDate:r}}).subscribe({next:_=>console.log("Facture Storecove initi\xe9e:",_),error:_=>{console.error("Erreur cr\xe9ation facture Storecove:",_),t.warningMessage="La demande est envoy\xe9e, mais la facture n'a pas pu \xeatre g\xe9n\xe9r\xe9e automatiquement (API indisponible)."}});const x=`${b.c.stripe_lien_paiement}/paiement/${c.uid}`,re=`${b.c.stripe_lien_paiement}/p/${c.uid}`;let g=`Paiement requis: ${s}\u20ac pour "${l}" (devis ${t.quoteId}). \xc9ch\xe9ance: ${new Date(r).toLocaleDateString("fr-BE")}. Payer: ${x}`;g.length>160&&(g=`Paiement requis: ${s}\u20ac pour "${l}" (devis ${t.quoteId}). \xc9ch\xe9ance: ${new Date(r).toLocaleDateString("fr-BE")}. Payer: ${re}`);const ie=`Demande de paiement pour votre devis N\xb0${t.quoteId}`,ae=`\n        <p>Bonjour ${t.preneurDetails.prenom||""},</p>\n        <p>Une demande de paiement de <strong>${s}\u20ac</strong> a \xe9t\xe9 \xe9mise pour votre devis N\xb0${t.quoteId}.</p>\n        <ul>\n          <li><strong>Sujet :</strong> ${l}</li>\n          <li><strong>Montant :</strong> ${s}\u20ac</li>\n          <li><strong>Date d'\xe9ch\xe9ance :</strong> ${new Date(r).toLocaleDateString("fr-BE")}</li>\n        </ul>\n        ${m?`<p><strong>Remarques :</strong> ${m}</p>`:""}\n        <p>Vous pouvez effectuer le paiement en cliquant sur le lien ci-dessous :</p>\n        <p><a href="${x}" style="padding: 10px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px;">Payer maintenant</a></p>\n        <p>Cordialement,<br>L'\xe9quipe assurkin</p>\n      `,v={to:t.preneurDetails.email,subject:ie,htmlContent:ae};yield Promise.all([t.smsService.sendSms(t.preneurDetails.telephone,g).then(()=>t.saveMessageToDb("sms","sent",{recipient:t.preneurDetails.telephone,content:g,subject:`Demande de paiement: ${l}`})),t.mailService.sendEmail(v).toPromise().then(()=>t.saveMessageToDb("email","sent",{recipient:v.to,subject:v.subject,content:v.htmlContent}))]),t.successMessage="La demande de paiement a \xe9t\xe9 cr\xe9\xe9e et envoy\xe9e avec succ\xe8s par SMS et e-mail.",t.paymentForm.reset(),t.paymentForm.get("sujet")?.setValue(""),t.loadPayments()}catch(c){console.error("Erreur lors du processus de demande de paiement:",c),t.errorMessage=c.message||"Une erreur est survenue lors de la cr\xe9ation ou de l'envoi de la demande de paiement."}finally{t.loading=!1}})()}saveCommission(){this.commissionForm.invalid?this.commissionForm.markAllAsTouched():(this.loading=!0,this.resetMessages(),this.dbService.saveCommission({quote_id:this.quoteId,quote_type:this.quoteType,categorie:this.commissionForm.value.categorie,montant:this.commissionForm.value.montant,date_echeance:this.commissionForm.value.dateEcheance,date_paiement:this.commissionForm.value.datePaiement||null,compagnie:this.commissionForm.value.compagnie}).subscribe({next:()=>{this.successMessage="Commission enregistr\xe9e avec succ\xe8s.",this.commissionForm.reset(),this.loading=!1},error:o=>{console.error("Erreur lors de l'enregistrement de la commission:",o),this.errorMessage="Une erreur est survenue lors de l'enregistrement de la commission.",this.loading=!1}}))}loadPayments(){!this.quoteId||!this.quoteType||this.paymentService.getPaymentRequestsByQuote(this.quoteId,this.quoteType).subscribe({next:t=>this.payments=t,error:t=>console.error("Erreur chargement paiements",t)})}downloadInvoice(t){t.storecove_invoice_id&&(this.loading=!0,this.storecoveService.downloadInvoice(t.storecove_invoice_id).subscribe({next:o=>{const s=window.URL.createObjectURL(o),r=document.createElement("a");r.href=s,r.download=`facture_${t.storecove_invoice_id}.pdf`,r.click(),window.URL.revokeObjectURL(s),this.loading=!1},error:o=>{console.error("Erreur t\xe9l\xe9chargement facture",o),this.errorMessage="Impossible de t\xe9l\xe9charger la facture.",this.loading=!1}}))}retryInvoice(t){this.preneurDetails?(this.loading=!0,this.resetMessages(),this.storecoveService.createInvoice({paymentRequestId:t.id,customer:{id:this.preneurDetails.id,name:`${this.preneurDetails.prenom} ${this.preneurDetails.nom}`,email:this.preneurDetails.email,address:this.preneurDetails.adresse,postalCode:this.preneurDetails.code_postal,city:this.preneurDetails.ville},invoiceDetails:{amount:t.montant,description:t.sujet,dueDate:t.date_echeance}}).subscribe({next:s=>{console.log("Facture Storecove r\xe9g\xe9n\xe9r\xe9e:",s),this.successMessage="La facture a \xe9t\xe9 g\xe9n\xe9r\xe9e avec succ\xe8s.",this.loadPayments(),this.loading=!1},error:s=>{console.error("Erreur r\xe9g\xe9n\xe9ration facture Storecove:",s),this.warningMessage="\xc9chec de la r\xe9g\xe9n\xe9ration de la facture. Veuillez v\xe9rifier les logs.",this.loading=!1}})):this.errorMessage="Impossible de r\xe9essayer la facture : d\xe9tails du preneur manquants."}saveMessageToDb(t,o,s){var r=this;return(0,p.A)(function*(){if(!r.quoteType||!r.quoteId)return void console.error("Impossible de sauvegarder le message : informations sur le devis manquantes.");const m={categorie:r.quoteType,categorie_id:r.quoteId,type:t,status:o,...s};yield r.dbService.saveMessage(m)})()}resetMessages(){this.successMessage=null,this.warningMessage=null,this.errorMessage=null}futureDateValidator(t){if(t.value){const o=new Date;if(o.setHours(0,0,0,0),new Date(t.value)<o)return{pastDate:!0}}return null}static \u0275fac=function(o){return new(o||n)};static \u0275cmp=e.VBU({type:n,selectors:[["app-messagerie"]],standalone:!0,features:[e.aNF],decls:34,vars:14,consts:[[1,"container","mx-auto","p-4","sm:p-6","lg:p-8"],[1,"flex","items-center","justify-between","mb-6"],[1,"text-2xl","sm:text-3xl","font-bold","text-gray-800"],[1,"text-blue-600","hover:text-blue-800","font-medium","flex","items-center",3,"routerLink"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 0 20 20","fill","currentColor",1,"h-5","w-5","mr-2"],["fill-rule","evenodd","d","M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z","clip-rule","evenodd"],[1,"border-b","border-gray-200","mb-6"],["aria-label","Tabs",1,"-mb-px","flex","space-x-6"],[1,"whitespace-nowrap","py-4","px-1","border-b-2","font-medium","text-sm","flex","items-center",3,"click","ngClass"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke-width","1.5","stroke","currentColor",1,"w-5","h-5","mr-2"],["stroke-linecap","round","stroke-linejoin","round","d","M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3"],["stroke-linecap","round","stroke-linejoin","round","d","M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"],["stroke-linecap","round","stroke-linejoin","round","d","M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z"],["stroke-linecap","round","stroke-linejoin","round","d","M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"],[1,"bg-white","p-6","rounded-lg","shadow-md"],["class","mb-4 p-4 text-sm text-green-700 bg-green-100 rounded-lg","role","alert",4,"ngIf"],["class","mb-4 p-4 text-sm text-yellow-700 bg-yellow-100 rounded-lg","role","alert",4,"ngIf"],["class","mb-4 p-4 text-sm text-red-700 bg-red-100 rounded-lg","role","alert",4,"ngIf"],[4,"ngIf"],["role","alert",1,"mb-4","p-4","text-sm","text-green-700","bg-green-100","rounded-lg"],["role","alert",1,"mb-4","p-4","text-sm","text-yellow-700","bg-yellow-100","rounded-lg"],["role","alert",1,"mb-4","p-4","text-sm","text-red-700","bg-red-100","rounded-lg"],[3,"ngSubmit","formGroup"],[1,"mb-4"],["for","sms-to",1,"block","text-sm","font-medium","text-gray-700"],["type","text","id","sms-to","formControlName","to",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],["for","sms-message",1,"block","text-sm","font-medium","text-gray-700"],["id","sms-message","formControlName","message","rows","5",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],[1,"text-right","text-xs","text-gray-500","mt-1"],[1,"text-right"],["type","submit",1,"inline-flex","justify-center","py-2","px-4","border","border-transparent","shadow-sm","text-sm","font-medium","rounded-md","text-white","bg-blue-600","hover:bg-blue-700","focus:outline-none","focus:ring-2","focus:ring-offset-2","focus:ring-blue-500","disabled:opacity-50","disabled:cursor-not-allowed",3,"disabled"],["class","animate-spin -ml-1 mr-3 h-5 w-5 text-white","xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24",4,"ngIf"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24",1,"animate-spin","-ml-1","mr-3","h-5","w-5","text-white"],["cx","12","cy","12","r","10","stroke","currentColor","stroke-width","4",1,"opacity-25"],["fill","currentColor","d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z",1,"opacity-75"],["for","email-to",1,"block","text-sm","font-medium","text-gray-700"],["type","email","id","email-to","formControlName","to",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],["for","email-subject",1,"block","text-sm","font-medium","text-gray-700"],["type","text","id","email-subject","formControlName","subject",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],["for","email-content",1,"block","text-sm","font-medium","text-gray-700"],["id","email-content","formControlName","htmlContent","rows","10",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],["for","payment-subject",1,"block","text-sm","font-medium","text-gray-700"],["id","payment-subject","formControlName","sujet",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],["value","","disabled",""],[3,"value",4,"ngFor","ngForOf"],["class","text-red-600 text-xs mt-1",4,"ngIf"],["for","payment-amount",1,"block","text-sm","font-medium","text-gray-700"],[1,"relative","mt-1"],["type","number","id","payment-amount","formControlName","montant","placeholder","0.00",1,"pl-3","pr-12","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","ring-1","ring-slate-200","shadow-sm"],[1,"absolute","inset-y-0","right-0","pr-3","flex","items-center","pointer-events-none"],[1,"text-gray-500","sm:text-sm"],["for","payment-due-date",1,"block","text-sm","font-medium","text-gray-700"],["type","date","id","payment-due-date","formControlName","dateEcheance",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],[1,"mb-6"],["for","payment-remarks",1,"block","text-sm","font-medium","text-gray-700"],["id","payment-remarks","formControlName","remarques","rows","4","placeholder","Ajoutez des informations compl\xe9mentaires pour le client...",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],[1,"mt-10","border-t","border-gray-200","pt-8"],[1,"text-lg","font-medium","leading-6","text-gray-900","mb-4"],[1,"flex","flex-col"],[1,"-my-2","overflow-x-auto","sm:-mx-6","lg:-mx-8"],[1,"py-2","align-middle","inline-block","min-w-full","sm:px-6","lg:px-8"],[1,"shadow","overflow-hidden","border-b","border-gray-200","sm:rounded-lg"],[1,"min-w-full","divide-y","divide-gray-200"],[1,"bg-gray-50"],["scope","col",1,"px-6","py-3","text-left","text-xs","font-medium","text-gray-500","uppercase","tracking-wider"],[1,"bg-white","divide-y","divide-gray-200"],[4,"ngFor","ngForOf"],[3,"value"],[1,"text-red-600","text-xs","mt-1"],[1,"px-6","py-4","whitespace-nowrap","text-sm","text-gray-500"],[1,"px-6","py-4","whitespace-nowrap","text-sm","text-gray-900"],[1,"px-6","py-4","whitespace-nowrap"],[1,"px-2","inline-flex","text-xs","leading-5","font-semibold","rounded-full",3,"ngClass"],["class","text-indigo-600 hover:text-indigo-900 flex items-center",3,"click",4,"ngIf"],["class","text-orange-600 hover:text-orange-900 flex items-center text-xs","title","G\xe9n\xe9rer la facture",3,"click",4,"ngIf"],[1,"text-indigo-600","hover:text-indigo-900","flex","items-center",3,"click"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-4","w-4","mr-1"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"],["title","G\xe9n\xe9rer la facture",1,"text-orange-600","hover:text-orange-900","flex","items-center","text-xs",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"],["colspan","4",1,"px-6","py-4","whitespace-nowrap","text-sm","text-gray-500","text-center"],["for","comm-categorie",1,"block","text-sm","font-medium","text-gray-700"],["id","comm-categorie","formControlName","categorie",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],["for","comm-montant",1,"block","text-sm","font-medium","text-gray-700"],["type","number","id","comm-montant","formControlName","montant","placeholder","0.00",1,"pl-3","pr-12","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","ring-1","ring-slate-200","shadow-sm"],["for","comm-dateEcheance",1,"block","text-sm","font-medium","text-gray-700"],["type","date","id","comm-dateEcheance","formControlName","dateEcheance",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],["for","comm-datePaiement",1,"block","text-sm","font-medium","text-gray-700"],["type","date","id","comm-datePaiement","formControlName","datePaiement",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],[1,"mb-4","md:col-span-2"],["for","comm-compagnie",1,"block","text-sm","font-medium","text-gray-700"],["id","comm-compagnie","formControlName","compagnie",1,"mt-1","focus:ring-2","focus:ring-blue-500","focus:outline-none","appearance-none","w-full","text-sm","leading-6","text-slate-900","placeholder-slate-400","rounded-md","py-2","px-3","ring-1","ring-slate-200","shadow-sm"],[1,"text-right","mt-4"]],template:function(o,s){1&o&&(e.j41(0,"div",0)(1,"div",1)(2,"h1",2),e.EFF(3),e.k0s(),e.j41(4,"a",3),e.qSk(),e.j41(5,"svg",4),e.nrm(6,"path",5),e.k0s(),e.EFF(7," Retour \xe0 la gestion "),e.k0s()(),e.joV(),e.j41(8,"div",6)(9,"nav",7)(10,"button",8),e.bIt("click",function(){return s.setActiveTab("sms")}),e.qSk(),e.j41(11,"svg",9),e.nrm(12,"path",10),e.k0s(),e.EFF(13," SMS "),e.k0s(),e.joV(),e.j41(14,"button",8),e.bIt("click",function(){return s.setActiveTab("email")}),e.qSk(),e.j41(15,"svg",9),e.nrm(16,"path",11),e.k0s(),e.EFF(17," Email "),e.k0s(),e.joV(),e.j41(18,"button",8),e.bIt("click",function(){return s.setActiveTab("payment")}),e.qSk(),e.j41(19,"svg",9),e.nrm(20,"path",12),e.k0s(),e.EFF(21," Paiement "),e.k0s(),e.joV(),e.j41(22,"button",8),e.bIt("click",function(){return s.setActiveTab("commissions")}),e.qSk(),e.j41(23,"svg",9),e.nrm(24,"path",13),e.k0s(),e.EFF(25," Commissions "),e.k0s()()(),e.joV(),e.j41(26,"div",14),e.DNE(27,$,2,1,"div",15)(28,I,2,1,"div",16)(29,T,2,1,"div",17)(30,q,16,5,"div",18)(31,P,18,4,"div",18)(32,H,60,12,"div",18)(33,ne,41,11,"div",18),e.k0s()()),2&o&&(e.R7$(3),e.SpI(" Donn\xe9es #",s.quoteId," "),e.R7$(),e.Y8G("routerLink",e.lJ4(13,C)),e.R7$(6),e.Y8G("ngClass","sms"===s.activeTab?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),e.R7$(4),e.Y8G("ngClass","email"===s.activeTab?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),e.R7$(4),e.Y8G("ngClass","payment"===s.activeTab?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),e.R7$(4),e.Y8G("ngClass","commissions"===s.activeTab?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),e.R7$(5),e.Y8G("ngIf",s.successMessage),e.R7$(),e.Y8G("ngIf",s.warningMessage),e.R7$(),e.Y8G("ngIf",s.errorMessage),e.R7$(),e.Y8G("ngIf","sms"===s.activeTab),e.R7$(),e.Y8G("ngIf","email"===s.activeTab),e.R7$(),e.Y8G("ngIf","payment"===s.activeTab),e.R7$(),e.Y8G("ngIf","commissions"===s.activeTab))},dependencies:[d.MD,d.YU,d.Sq,d.bT,d.Jj,d.oe,d.vh,a.X1,a.qT,a.xH,a.y7,a.me,a.Q0,a.wz,a.BC,a.cb,a.j4,a.JD,h.Wk],encapsulation:2})}return n})()}}]);