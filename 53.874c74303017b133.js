(self.webpackChunkassurkin=self.webpackChunkassurkin||[]).push([[53],{5053:(ve,ue,C)=>{"use strict";C.r(ue),C.d(ue,{UploaderComponent:()=>P});var de=C(467),e=C(4438),G=C(177),w=C(9417),H=C(9981),W=C(7673),J=C(9437),Z=C(7468),pe=C(980),p=C(6354),q=C(8264),ee=C(324),te=C(1807),Q=C(4125),re=C(262);let ce=(()=>{class s{constructor(){}csvToJSON(t,i=","){const o=re.parse(t,{header:!0,skipEmptyLines:!0,delimiter:i,dynamicTyping:!0});return o.errors.length>0&&console.error("Erreurs de parsing CSV:",o.errors),o.data}static \u0275fac=function(i){return new(i||s)};static \u0275prov=e.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),K=(()=>{class s{headerTranslations={"DTM+008":"dateEffet","RFF+001":"numeroPolice","PTY+006":"codeCompagnie","PTY+002":"intermediaire","NME+001":"nomOfficiel","ADR+002":"adresse","DTM+001":"dateNaissance","RFF+022":"numeroNational"};constructor(){}mapRawDataToDossier(t){return{informationsGenerales:{dateEffet:this.extractDate(t,"DTM\\+008"),numeroPolice:this.extract(t,"RFF\\+001"),codeCompagnie:this.extract(t,"PTY\\+006"),intermediaire:this.extract(t,"PTY\\+002")},preneurAssurance:{nomOfficiel:this.extract(t,"NME\\+001"),adresse:this.extract(t,"ADR\\+002"),dateNaissance:this.extractDate(t,"DTM\\+001"),numeroNational:this.extract(t,"RFF\\+022")},identificationVehicule:{dateImmatriculation:this.extractDate(t,"DTM\\+134"),dateRadiation:this.extractDate(t,"DTM\\+055"),dateMiseCirculation:this.extractDate(t,"DTM\\+013"),numeroPlaque:this.extract(t,"RFF\\+010"),numeroChassis:this.extract(t,"RFF\\+011"),numeroPVG:this.extract(t,"RFF\\+012"),codeDIV:this.extract(t,"RFF\\+018"),typePlaque:this.extract(t,"ATT\\+5008")},caracteristiquesTechniques:{typeVehicule:this.extract(t,"ATT\\+5003"),carburant:this.mapCarburant(this.extract(t,"ATT\\+5015")),couleur:this.extract(t,"ATT\\+5019"),cylindree:this.parseNumber(this.extract(t,"QTY\\+003")),puissance:this.parseNumber(this.extract(t,"QTY\\+004")),poidsOperationnel:this.parseNumber(this.extract(t,"QTY\\+105")),nombrePlacesAssises:this.parseNumber(this.extract(t,"QTY\\+002")),nombrePlacesDebout:this.parseNumber(this.extract(t,"QTY\\+122"))}}}extract(t,i){const o=new RegExp(`${i}\\s*\\(.*?\\)\\s*(.*?)(?=\\s*[A-Z]{3}\\+|$)`,"is"),c=t.match(o);return c&&c[1]?c[1].trim():""}extractDate(t,i){const o=this.extract(t,i);if(!o)return;const c=o.split("-");return 3===c.length?new Date(Number(c[2]),Number(c[1])-1,Number(c[0])):void 0}mapCarburant(t){return t.replace("01","").trim(),t.includes("01")?"Essence":t.includes("02")?"Diesel":t.includes("03")?"LPG":t.includes("08")?"\xc9lectrique":t.includes("09")?"Hybride":t}parseNumber(t){const i=parseInt(t,10);return isNaN(i)?0:i}getFrenchTranslation(t){const i=t.match(/^[A-Z]{3}\+\d+/);return this.headerTranslations[i?i[0]:t]}static \u0275fac=function(i){return new(i||s)};static \u0275prov=e.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();const se={dateEffet:"Date d'effet",numeroPolice:"Num\xe9ro de Police",codeCompagnie:"Code Compagnie",intermediaire:"Interm\xe9diaire",nomOfficiel:"Nom du preneur",adresse:"Adresse",dateNaissance:"Date de Naissance",numeroNational:"Num\xe9ro National",dateImmatriculation:"Date 1\xe8re Immat.",dateMiseCirculation:"Date 1\xe8re Circ.",numeroPlaque:"Plaque",numeroChassis:"N\xb0 de Chassis",carburant:"Carburant",puissance:"Puissance (kW)",cylindree:"Cylindr\xe9e (cm\xb3)"};var ge=C(5312);function he(s,d){if(1&s){const t=e.RV6();e.j41(0,"tr",51)(1,"td",52)(2,"a",53),e.bIt("click",function(){const o=e.eBV(t).$implicit,c=e.XpG(3);return e.Njj(c.downloadFile(o))}),e.qSk(),e.j41(3,"svg",54),e.nrm(4,"path",55),e.k0s(),e.joV(),e.j41(5,"span",56),e.EFF(6),e.k0s()()(),e.j41(7,"td",57),e.EFF(8),e.k0s(),e.j41(9,"td",57),e.EFF(10),e.nI1(11,"date"),e.k0s()()}if(2&s){const t=d.$implicit;e.R7$(2),e.AVh("opacity-50",!t.downloadUrl)("pointer-events-none",!t.downloadUrl),e.Y8G("title",t.downloadUrl?"T\xe9l\xe9charger "+t.file_name:"G\xe9n\xe9ration du lien..."),e.R7$(3),e.Y8G("title",t.file_name),e.R7$(),e.JRh(t.file_name),e.R7$(2),e.JRh(t.raisons),e.R7$(2),e.JRh(e.i5U(11,9,t.date_created,"dd/MM/yyyy HH:mm"))}}function fe(s,d){if(1&s&&(e.j41(0,"div")(1,"h3",42),e.qSk(),e.j41(2,"svg",43),e.nrm(3,"path",44),e.k0s(),e.EFF(4," Fichiers sauvegard\xe9s "),e.k0s(),e.joV(),e.j41(5,"div",45)(6,"table",46)(7,"thead",47)(8,"tr")(9,"th",48),e.EFF(10,"Fichier"),e.k0s(),e.j41(11,"th",48),e.EFF(12,"Type"),e.k0s(),e.j41(13,"th",48),e.EFF(14,"Date d'ajout"),e.k0s()()(),e.j41(15,"tbody",49),e.DNE(16,he,12,12,"tr",50),e.k0s()()()()),2&s){const t=e.XpG().ngIf;e.R7$(16),e.Y8G("ngForOf",t)}}function oe(s,d){1&s&&(e.j41(0,"div",58)(1,"p",33),e.EFF(2,"Aucun fichier n'a encore \xe9t\xe9 associ\xe9 \xe0 ce devis."),e.k0s()())}function B(s,d){if(1&s&&(e.j41(0,"div",40),e.DNE(1,fe,17,1,"div",41)(2,oe,3,0,"ng-template",null,1,e.C5r),e.k0s()),2&s){const t=d.ngIf,i=e.sdS(3);e.R7$(),e.Y8G("ngIf",t.length>0)("ngIfElse",i)}}function S(s,d){1&s&&e.nrm(0,"div",59)}function r(s,d){1&s&&(e.qSk(),e.j41(0,"svg",82),e.nrm(1,"circle",83)(2,"path",84),e.k0s())}function n(s,d){1&s&&(e.qSk(),e.j41(0,"svg",85),e.nrm(1,"path",86),e.k0s())}function a(s,d){1&s&&(e.qSk(),e.j41(0,"svg",87),e.nrm(1,"path",88),e.k0s())}function u(s,d){1&s&&(e.qSk(),e.j41(0,"svg",89),e.nrm(1,"path",90),e.k0s())}function l(s,d){if(1&s&&(e.j41(0,"p",91),e.EFF(1),e.k0s()),2&s){const t=e.XpG().$implicit;e.R7$(),e.SpI(" ",t.error||"Erreur lors de l'envoi"," ")}}function _(s,d){if(1&s){const t=e.RV6();e.j41(0,"button",92),e.bIt("click",function(){e.eBV(t);const o=e.XpG().index,c=e.XpG(2);return e.Njj(c.removeFile(o))}),e.j41(1,"span",93),e.EFF(2,"Supprimer"),e.k0s(),e.qSk(),e.j41(3,"svg",94),e.nrm(4,"path",95),e.k0s()()}}function T(s,d){if(1&s&&(e.j41(0,"option",96),e.EFF(1),e.k0s()),2&s){const t=d.$implicit;e.Y8G("value",t.Label),e.R7$(),e.SpI(" ",t.Label," ")}}function N(s,d){if(1&s){const t=e.RV6();e.j41(0,"li",64)(1,"div",65)(2,"div",66)(3,"div",67),e.qex(4,68),e.DNE(5,r,3,0,"svg",69)(6,n,2,0,"svg",70)(7,a,2,0,"svg",71)(8,u,2,0,"svg",72),e.bVm(),e.k0s(),e.j41(9,"div",73)(10,"p",74),e.EFF(11),e.k0s(),e.j41(12,"p",21),e.EFF(13),e.k0s(),e.DNE(14,l,2,1,"p",75),e.k0s()(),e.DNE(15,_,5,0,"button",76),e.k0s(),e.j41(16,"div",77)(17,"label",78),e.EFF(18,"Type de document"),e.k0s(),e.j41(19,"select",79),e.mxI("ngModelChange",function(o){const c=e.eBV(t).$implicit;return e.DH7(c.raison,o)||(c.raison=o),e.Njj(o)}),e.j41(20,"option",80),e.EFF(21,"Choisir un type..."),e.k0s(),e.DNE(22,T,2,2,"option",81),e.k0s()()()}if(2&s){const t=d.$implicit,i=d.index,o=e.XpG(2);e.R7$(4),e.Y8G("ngSwitch",t.status),e.R7$(),e.Y8G("ngSwitchCase","uploading"),e.R7$(),e.Y8G("ngSwitchCase","success"),e.R7$(),e.Y8G("ngSwitchCase","error"),e.R7$(3),e.Y8G("title",t.file.name),e.R7$(),e.SpI(" ",t.file.name," "),e.R7$(2),e.SpI(" ",(t.file.size/1024).toFixed(2)," KB "),e.R7$(),e.Y8G("ngIf","error"===t.status),e.R7$(),e.Y8G("ngIf","pending"===t.status||"error"===t.status),e.R7$(2),e.Y8G("for","raison-"+i),e.R7$(2),e.Y8G("id","raison-"+i),e.R50("ngModel",t.raison),e.Y8G("name","raison-"+i)("disabled","pending"!==t.status&&"error"!==t.status),e.R7$(3),e.Y8G("ngForOf",o.documentTypes)}}function $(s,d){if(1&s&&(e.j41(0,"div",60)(1,"h3",61),e.EFF(2),e.k0s(),e.j41(3,"ul",62),e.DNE(4,N,23,15,"li",63),e.k0s()()),2&s){const t=e.XpG();e.R7$(2),e.SpI("Fichiers \xe0 traiter (",t.uploadStates.length,") :"),e.R7$(2),e.Y8G("ngForOf",t.uploadStates)}}function x(s,d){1&s&&(e.j41(0,"div",97),e.qSk(),e.j41(1,"svg",98),e.nrm(2,"path",86),e.k0s(),e.EFF(3," Tout est enregistr\xe9 ! "),e.k0s())}function F(s,d){if(1&s&&(e.j41(0,"div",99),e.qSk(),e.j41(1,"svg",98),e.nrm(2,"path",88),e.k0s(),e.EFF(3),e.k0s()),2&s){const t=e.XpG();e.R7$(3),e.SpI(" ",t.errorMessage," ")}}function f(s,d){1&s&&(e.qSk(),e.j41(0,"svg",100),e.nrm(1,"circle",83)(2,"path",84),e.k0s())}function O(s,d){if(1&s&&(e.j41(0,"td",112),e.EFF(1),e.k0s()),2&s){const t=d.$implicit,i=e.XpG().$implicit;e.R7$(),e.SpI(" ",t[i]," ")}}function v(s,d){if(1&s&&(e.j41(0,"tr")(1,"th",110),e.EFF(2),e.k0s(),e.DNE(3,O,2,1,"td",111),e.k0s()),2&s){const t=d.$implicit,i=e.XpG(2);e.R7$(2),e.SpI(" ",t," "),e.R7$(),e.Y8G("ngForOf",i.csvData)}}function b(s,d){1&s&&(e.j41(0,"span",113),e.EFF(1,"Donn\xe9es enregistr\xe9es avec succ\xe8s."),e.k0s())}function h(s,d){if(1&s&&(e.j41(0,"span",114),e.EFF(1),e.k0s()),2&s){const t=e.XpG(2);e.R7$(),e.JRh(t.csvSaveError)}}function I(s,d){1&s&&(e.qSk(),e.j41(0,"svg",115),e.nrm(1,"circle",83)(2,"path",84),e.k0s())}function R(s,d){if(1&s){const t=e.RV6();e.j41(0,"div",101)(1,"h3",102),e.EFF(2,"Aper\xe7u du contenu"),e.k0s(),e.j41(3,"div",103)(4,"table",46)(5,"tbody",49),e.DNE(6,v,4,2,"tr",104),e.k0s()()(),e.j41(7,"div",105),e.DNE(8,b,2,0,"span",106)(9,h,2,1,"span",107),e.j41(10,"button",108),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.onSaveCsvData())}),e.DNE(11,I,3,0,"svg",109),e.EFF(12),e.k0s()()()}if(2&s){const t=e.XpG();e.R7$(6),e.Y8G("ngForOf",t.getObjectKeys(t.csvData[0])),e.R7$(2),e.Y8G("ngIf",t.csvSaveSuccess),e.R7$(),e.Y8G("ngIf",t.csvSaveError),e.R7$(),e.Y8G("disabled",t.isSavingCsvData),e.R7$(),e.Y8G("ngIf",t.isSavingCsvData),e.R7$(),e.SpI(" ",t.isSavingCsvData?"Enregistrement...":"Confirmer et Enregistrer"," ")}}function D(s,d){1&s&&(e.j41(0,"p",116),e.EFF(1,"Aucune donn\xe9e charg\xe9e pour le moment."),e.k0s())}let P=(()=>{class s{route=(0,e.WQX)(H.nX);router=(0,e.WQX)(H.Ix);uploaderService=(0,e.WQX)(q.U);contractService=(0,e.WQX)(ee.y);dbConnectService=(0,e.WQX)(te.y);imatService=(0,e.WQX)(ce);sendsmsService=(0,e.WQX)(Q.T);assuranceMapperService=(0,e.WQX)(K);quoteId;quoteType;preneurId;uploadStates=[];isUploading=!1;globalUploadProgress=0;uploadSuccess=!1;errorMessage=null;documentTypes=[];existingFiles$=(0,W.of)([]);clientInfo=null;isSavingCsvData=!1;isParsingCsv=!1;csvSaveSuccess=!1;csvSaveError=null;csvData=[];ngOnInit(){const t=this.route.snapshot.paramMap;if(this.quoteId=Number(t.get("id")),this.quoteType=t.get("type")||"",this.preneurId=Number(t.get("preneurId")),!this.quoteId||!this.quoteType||!this.preneurId)return this.errorMessage="Les informations du devis ou du preneur sont manquantes.",void console.error("Quote ID, Type or Preneur ID is missing.");this.initData()}initData(){this.refreshExistingFiles$(),this.loadDocumentTypes(),this.dbConnectService.getCsvData(this.quoteId,this.quoteType).subscribe({next:t=>{this.csvData=t},error:t=>console.error("Erreur chargement CSV:",t)}),this.dbConnectService.getQuoteDetails(this.quoteType,this.quoteId).subscribe({next:t=>{this.clientInfo=t?.preneur},error:t=>console.error("Erreur lors de la r\xe9cup\xe9ration des d\xe9tails du devis:",t)})}loadDocumentTypes(){this.dbConnectService.getDocumentTypes().subscribe({next:t=>this.documentTypes=t,error:t=>console.error("Erreur chargement types documents:",t)})}onFileSelected(t){const i=t.target;if(i.files&&i.files.length>0){const o=Array.from(i.files).filter(c=>!this.uploadStates.some(y=>y.file.name===c.name)).map(c=>({file:c,status:"pending",raison:"",error:void 0}));this.uploadStates=[...this.uploadStates,...o],this.uploadSuccess=!1,this.errorMessage=null,i.value=""}}removeFile(t){this.uploadStates.splice(t,1)}onUpload(){const t=this.uploadStates.filter(i=>"pending"===i.status);0!==t.length?(this.isUploading=!0,this.errorMessage=null,this.globalUploadProgress=0,t.forEach(i=>i.status="uploading"),this.uploaderService.uploadContractFiles(t.map(i=>i.file),this.quoteId,this.quoteType).subscribe({next:i=>{"number"==typeof i.totalProgress&&(this.globalUploadProgress=i.totalProgress);const o=this.uploadStates.find(c=>c.file.name===i.fileName);o&&(o.status=i.status,"success"===i.status?o.filePath=i.path:o.error=i.error)},error:i=>{this.errorMessage="Erreur technique lors de l'envoi.",this.isUploading=!1,this.globalUploadProgress=0},complete:()=>{this.isUploading=!1,this.uploadStates.some(o=>"success"===o.status&&o.filePath&&!this.isFileSaved(o))&&this.saveFilesToDbAndRefresh(),this.uploadSuccess=this.uploadStates.every(o=>"success"===o.status)}})):this.errorMessage="Aucun nouveau fichier \xe0 envoyer."}isFileSaved(t){return!1}saveFilesToDbAndRefresh(){const t=this.uploadStates.filter(o=>"success"===o.status&&o.filePath);if(0===t.length)return;const i=t.map(o=>(console.log(`Fichier t\xe9l\xe9vers\xe9 : '${o.file.name}', Type : '${o.raison}'`),this.contractService.addContractFile(this.quoteId,this.quoteType,o.filePath,o.file.name,o.raison,this.preneurId).pipe((0,J.W)(c=>(console.error(`Failed to save ref for ${o.file.name}`,c),o.error="Erreur sauvegarde BDD",o.status="error",(0,W.of)(null))))));(0,Z.p)(i).subscribe({next:()=>{console.log("Synchronisation BDD termin\xe9e."),this.refreshExistingFiles$(),this.uploadStates=this.uploadStates.filter(o=>"success"!==o.status)},complete:()=>{const o=t.find(c=>"Contrat"===c.raison);o&&this.clientInfo?.telephone?this.sendContractSms(this.clientInfo.telephone,this.clientInfo.prenom):o&&(console.warn("Un contrat a \xe9t\xe9 upload\xe9 mais aucun num\xe9ro de t\xe9l\xe9phone n'a \xe9t\xe9 trouv\xe9 pour le client."),this.errorMessage="Contrat sauvegard\xe9, mais le SMS n'a pas pu \xeatre envoy\xe9 (num\xe9ro de t\xe9l\xe9phone manquant).")},error:o=>{this.errorMessage="Erreur critique lors de la sauvegarde."}})}onCsvFileSelected(t){const i=t.target;if(i.files&&i.files.length>0){this.resetCsvSaveStatus(),this.isParsingCsv=!0;const o=i.files[0],c=new FileReader;c.onload=y=>{try{const m=this.csvToJSON(y.target.result);if(0===m.length)throw new Error("Le fichier CSV est vide ou ne contient pas de donn\xe9es valides.");this.csvData=m}catch(g){this.csvSaveError=g.message,this.csvData=[]}finally{this.isParsingCsv=!1}},c.readAsText(o),i.value=""}}csvToJSON(t){if(!t||""===t.trim())return[];const i=t.trim().split(/\r?\n/);if(i.length<2)throw new Error("Le fichier CSV doit contenir au moins un en-t\xeate et une ligne de donn\xe9es.");const c=i[0].split(";").map(g=>g.trim()).map(g=>this.assuranceMapperService.getFrenchTranslation(g)||g),y=[];for(let g=1;g<i.length;g++){const m=i[g];if(!m||""===m.trim())continue;const U=m.split(";"),k={};for(let E=0;E<c.length;E++){const j=U[E]?U[E].trim():"";k[c[E]]=j}Object.values(k).some(E=>""!==E)&&y.push(k)}return y}onSaveCsvData(){this.csvData.length?(this.isSavingCsvData=!0,this.resetCsvSaveStatus(),this.dbConnectService.saveCsvDataToDb(this.quoteId,this.quoteType,this.csvData).pipe((0,pe.j)(()=>this.isSavingCsvData=!1)).subscribe({next:()=>{this.csvSaveSuccess=!0,this.dbConnectService.getCsvData(this.quoteId,this.quoteType).subscribe(t=>this.csvData=t)},error:t=>{this.csvSaveError=`Erreur lors de la sauvegarde : ${t.message||"Une erreur inconnue est survenue."}`}})):this.csvSaveError="Aucune donn\xe9e \xe0 sauvegarder. Veuillez s\xe9lectionner un fichier CSV valide."}resetCsvSaveStatus(){this.csvSaveSuccess=!1,this.csvSaveError=null}getFriendlyHeader(t){return se[t]||t}getObjectKeys(t){return t?Object.keys(t):[]}hasPendingFiles(){return this.uploadStates.some(t=>"pending"===t.status)}refreshExistingFiles$(){this.existingFiles$=this.contractService.getContractFiles(this.quoteId,this.quoteType).pipe((0,p.T)(t=>t&&0!==t.length?t.map(i=>{const o=this.getPublicDownloadUrl(i.path,this.quoteType);return{...i,downloadUrl:o}}):[]),(0,J.W)(t=>(console.error("Erreur lors du rafra\xeechissement de la liste des fichiers:",t),(0,W.of)([]))))}allPendingFilesHaveReason(){return this.uploadStates.filter(i=>"pending"===i.status).every(i=>i.raison&&""!==i.raison.trim())}getPublicDownloadUrl(t,i){if(!t||!i)return null;const o=this.uploaderService.getBucketName(i),c=t.startsWith("/")?t.substring(1):t;return this.uploaderService.getDownloadUrl(o,c)}downloadFile(t){if(!t.downloadUrl)return void console.error("URL de t\xe9l\xe9chargement non disponible pour le fichier:",t.file_name);const i=document.createElement("a");i.href=`${t.downloadUrl}?download=${encodeURIComponent(t.file_name)}`,i.click()}sendContractSms(t,i){var o=this;return(0,de.A)(function*(){const c=`Bonjour ${i}, votre contrat est disponible dans votre espace client. Veuillez le signer. L'\xe9quipe assurkin. ${ge.c.website}`;try{yield o.sendsmsService.sendSms(t,c),console.log("SMS de confirmation de contrat envoy\xe9 avec succ\xe8s.")}catch(y){console.error("\xc9chec de l'envoi du SMS de confirmation de contrat:",y),o.errorMessage="Le contrat a \xe9t\xe9 sauvegard\xe9, mais une erreur est survenue lors de l'envoi du SMS de confirmation."}})()}goBack(){this.router.navigate(["auto"===this.quoteType?"/intranet/dashboard/auto-management":"/intranet/dashboard"])}static \u0275fac=function(i){return new(i||s)};static \u0275cmp=e.VBU({type:s,selectors:[["app-uploader"]],standalone:!0,features:[e.aNF],decls:55,vars:15,consts:[["noCsvData",""],["noFiles",""],[1,"container","mx-auto","p-4","sm:p-6","lg:p-8"],[1,"max-w-2xl","mx-auto","bg-white","p-8","rounded-lg","shadow-md"],["routerLink","/management",1,"inline-flex","items-center","text-indigo-600","hover:text-indigo-800","mb-4","group"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 0 20 20","fill","currentColor",1,"h-5","w-5","mr-2","transition-transform","group-hover:-translate-x-1"],["fill-rule","evenodd","d","M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z","clip-rule","evenodd"],[1,"text-2xl","font-bold","text-gray-800","mb-2"],[1,"text-gray-600","mb-6"],["class","mb-8",4,"ngIf"],[1,"my-8","border-gray-200"],[1,"mb-6"],["for","file-upload",1,"block","text-sm","font-medium","text-gray-700","mb-2"],[1,"mt-1","flex","justify-center","px-6","pt-5","pb-6","border-2","border-gray-300","border-dashed","rounded-md","hover:bg-gray-50","transition-colors","cursor-pointer","relative"],[1,"space-y-1","text-center"],["stroke","currentColor","fill","none","viewBox","0 0 48 48","aria-hidden","true",1,"mx-auto","h-12","w-12","text-gray-400"],["d","M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02","stroke-width","2","stroke-linecap","round","stroke-linejoin","round"],[1,"flex","text-sm","text-gray-600","justify-center"],["for","file-upload",1,"relative","cursor-pointer","bg-white","rounded-md","font-medium","text-blue-600","hover:text-blue-500","focus-within:outline-none","focus-within:ring-2","focus-within:ring-offset-2","focus-within:ring-blue-500"],["id","file-upload","type","file","multiple","",1,"sr-only",3,"change","disabled"],[1,"pl-1"],[1,"text-xs","text-gray-500"],["class","absolute inset-0 bg-white bg-opacity-50 cursor-not-allowed",4,"ngIf"],["class","mb-6 space-y-4",4,"ngIf"],[1,"flex","items-center","justify-between","border-t","border-gray-200","pt-6"],[1,"flex-1"],["class","text-sm text-green-600 font-medium flex items-center animate-pulse",4,"ngIf"],["class","text-sm text-red-600 font-medium flex items-center",4,"ngIf"],[1,"ml-4","inline-flex","items-center","px-6","py-3","border","border-transparent","text-sm","font-medium","rounded-md","shadow-sm","text-white","bg-blue-600","hover:bg-blue-700","focus:outline-none","focus:ring-2","focus:ring-offset-2","focus:ring-blue-500","disabled:bg-gray-300","disabled:cursor-not-allowed","transition-colors",3,"click","disabled"],["class","animate-spin -ml-1 mr-3 h-5 w-5 text-white","xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24",4,"ngIf"],[1,"mt-12","pt-8","border-t-2","border-gray-100"],[1,"flex","items-center","justify-between","mb-4"],[1,"text-lg","font-bold","text-gray-800"],[1,"text-sm","text-gray-500"],[1,"inline-flex","items-center","px-2.5","py-0.5","rounded-full","text-xs","font-medium","bg-gray-100","text-gray-800"],[1,"bg-gray-50","rounded-lg","p-6","border","border-gray-200"],[1,"mb-4"],[1,"block","text-sm","font-medium","text-gray-700","mb-2"],["type","file","accept",".csv",1,"block","w-full","text-sm","text-gray-500","file:mr-4","file:py-2","file:px-4","file:rounded-md","file:border-0","file:text-sm","file:font-semibold","file:bg-blue-100","file:text-blue-700","hover:file:bg-blue-200","transition-colors",3,"change"],["class","mt-6 animate-fade-in",4,"ngIf","ngIfElse"],[1,"mb-8"],[4,"ngIf","ngIfElse"],[1,"text-md","font-medium","text-gray-800","mb-4","flex","items-center"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-5","w-5","mr-2","text-green-600"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"overflow-hidden","border","border-gray-200","rounded-lg","shadow-sm"],[1,"min-w-full","divide-y","divide-gray-200"],[1,"bg-gray-50"],["scope","col",1,"px-6","py-3","text-left","text-xs","font-medium","text-gray-500","uppercase","tracking-wider"],[1,"bg-white","divide-y","divide-gray-200"],["class","hover:bg-gray-50 transition-colors",4,"ngFor","ngForOf"],[1,"hover:bg-gray-50","transition-colors"],[1,"px-6","py-4","text-sm","text-gray-800","font-medium","align-middle"],[1,"inline-flex","items-center","text-blue-600","hover:text-blue-800","group","cursor-pointer",3,"click","title"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-5","w-5","mr-2","text-gray-400","group-hover:text-blue-600","transition-colors"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"],[1,"block","max-w-xs","truncate","group-hover:underline",3,"title"],[1,"px-6","py-4","whitespace-nowrap","text-sm","text-gray-500"],[1,"text-center","bg-gray-50","py-6","rounded-lg","border","border-dashed","border-gray-300"],[1,"absolute","inset-0","bg-white","bg-opacity-50","cursor-not-allowed"],[1,"mb-6","space-y-4"],[1,"text-md","font-medium","text-gray-800"],[1,"space-y-3"],["class","bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm transition-all",4,"ngFor","ngForOf"],[1,"bg-gray-50","p-4","rounded-lg","border","border-gray-200","shadow-sm","transition-all"],[1,"flex","items-start","justify-between"],[1,"flex","items-center","min-w-0","flex-1"],[1,"flex-shrink-0","mr-3"],[3,"ngSwitch"],["class","animate-spin h-5 w-5 text-blue-500","xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24",4,"ngSwitchCase"],["class","h-6 w-6 text-green-500","fill","none","viewBox","0 0 24 24","stroke","currentColor",4,"ngSwitchCase"],["class","h-6 w-6 text-red-500","fill","none","viewBox","0 0 24 24","stroke","currentColor",4,"ngSwitchCase"],["class","h-6 w-6 text-gray-400","fill","none","viewBox","0 0 24 24","stroke","currentColor",4,"ngSwitchDefault"],[1,"min-w-0","flex-1"],[1,"text-sm","font-medium","text-gray-900","truncate",3,"title"],["class","text-xs text-red-600 mt-1",4,"ngIf"],["type","button","class","ml-4 flex-shrink-0 text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500","title","Supprimer de la liste",3,"click",4,"ngIf"],[1,"mt-3"],[1,"block","text-xs","font-medium","text-gray-700","mb-1",3,"for"],[1,"block","w-full","pl-3","pr-10","py-2","text-sm","border-gray-300","focus:outline-none","focus:ring-blue-500","focus:border-blue-500","rounded-md","disabled:bg-gray-100","disabled:text-gray-500",3,"ngModelChange","id","ngModel","name","disabled"],["value","","disabled",""],[3,"value",4,"ngFor","ngForOf"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24",1,"animate-spin","h-5","w-5","text-blue-500"],["cx","12","cy","12","r","10","stroke","currentColor","stroke-width","4",1,"opacity-25"],["fill","currentColor","d","M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z",1,"opacity-75"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6","text-green-500"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M5 13l4 4L19 7"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6","text-red-500"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6","text-gray-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"],[1,"text-xs","text-red-600","mt-1"],["type","button","title","Supprimer de la liste",1,"ml-4","flex-shrink-0","text-gray-400","hover:text-red-500","transition-colors","p-1","rounded-full","hover:bg-red-50","focus:outline-none","focus:ring-2","focus:ring-offset-2","focus:ring-red-500",3,"click"],[1,"sr-only"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-5","w-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"],[3,"value"],[1,"text-sm","text-green-600","font-medium","flex","items-center","animate-pulse"],["fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-4","w-4","mr-1"],[1,"text-sm","text-red-600","font-medium","flex","items-center"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24",1,"animate-spin","-ml-1","mr-3","h-5","w-5","text-white"],[1,"mt-6","animate-fade-in"],[1,"text-xs","font-semibold","text-gray-500","uppercase","tracking-wider","mb-2"],[1,"overflow-x-auto","border","border-gray-300","rounded-md","shadow-sm","mb-4","max-h-64","overflow-y-auto"],[4,"ngFor","ngForOf"],[1,"flex","items-center","justify-between","mt-4"],["class","text-sm text-green-600 font-medium",4,"ngIf"],["class","text-sm text-red-600 font-medium",4,"ngIf"],[1,"ml-auto","inline-flex","items-center","px-4","py-2","border","border-transparent","text-sm","font-medium","rounded-md","text-green-700","bg-green-100","hover:bg-green-200","focus:outline-none","focus:ring-2","focus:ring-offset-2","focus:ring-green-500","disabled:opacity-50","transition-colors",3,"click","disabled"],["class","animate-spin -ml-1 mr-2 h-4 w-4","xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24",4,"ngIf"],["scope","row",1,"px-4","py-2","bg-gray-50","text-left","text-xs","font-medium","text-gray-500","uppercase","w-1/4","sticky","left-0","border-r","border-gray-200"],["class","px-4 py-2 whitespace-nowrap text-sm text-gray-800 border-r border-gray-100 last:border-0",4,"ngFor","ngForOf"],[1,"px-4","py-2","whitespace-nowrap","text-sm","text-gray-800","border-r","border-gray-100","last:border-0"],[1,"text-sm","text-green-600","font-medium"],[1,"text-sm","text-red-600","font-medium"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24",1,"animate-spin","-ml-1","mr-2","h-4","w-4"],[1,"text-sm","text-gray-400","italic","mt-2"]],template:function(i,o){if(1&i){const c=e.RV6();e.j41(0,"div",2)(1,"div",3)(2,"a",4),e.qSk(),e.j41(3,"svg",5),e.nrm(4,"path",6),e.k0s(),e.EFF(5," Retour \xe0 la liste "),e.k0s(),e.joV(),e.j41(6,"h1",7),e.EFF(7,"T\xe9l\xe9verser des documents"),e.k0s(),e.j41(8,"p",8),e.EFF(9),e.k0s(),e.DNE(10,B,4,2,"div",9),e.nI1(11,"async"),e.nrm(12,"hr",10),e.j41(13,"div",11)(14,"label",12),e.EFF(15," Ajouter des documents "),e.k0s(),e.j41(16,"div",13)(17,"div",14),e.qSk(),e.j41(18,"svg",15),e.nrm(19,"path",16),e.k0s(),e.joV(),e.j41(20,"div",17)(21,"label",18)(22,"span"),e.EFF(23,"S\xe9lectionner des fichiers"),e.k0s(),e.j41(24,"input",19),e.bIt("change",function(g){return e.eBV(c),e.Njj(o.onFileSelected(g))}),e.k0s()(),e.j41(25,"p",20),e.EFF(26,"ou glisser-d\xe9poser"),e.k0s()(),e.j41(27,"p",21),e.EFF(28,"PDF, PNG, JPG jusqu'\xe0 10MB"),e.k0s()(),e.DNE(29,S,1,0,"div",22),e.k0s()(),e.DNE(30,$,5,2,"div",23),e.j41(31,"div",24)(32,"div",25),e.DNE(33,x,4,0,"div",26)(34,F,4,1,"div",27),e.k0s(),e.j41(35,"button",28),e.bIt("click",function(){return e.eBV(c),e.Njj(o.onUpload())}),e.DNE(36,f,3,0,"svg",29),e.EFF(37),e.k0s()(),e.j41(38,"div",30)(39,"div",31)(40,"div")(41,"h2",32),e.EFF(42,"Importation Donn\xe9es DIV"),e.k0s(),e.j41(43,"p",33),e.EFF(44,"Import CSV vers JSON"),e.k0s()(),e.j41(45,"span",34),e.EFF(46," Optionnel "),e.k0s()(),e.j41(47,"div",35)(48,"div",36)(49,"label",37),e.EFF(50,"S\xe9lectionner fichier .CSV"),e.k0s(),e.j41(51,"input",38),e.bIt("change",function(g){return e.eBV(c),e.Njj(o.onCsvFileSelected(g))}),e.k0s()(),e.DNE(52,R,13,6,"div",39)(53,D,2,0,"ng-template",null,0,e.C5r),e.k0s()()()()}if(2&i){const c=e.sdS(54);e.R7$(9),e.Lme("Pour le devis #",o.quoteId," (",o.quoteType,")"),e.R7$(),e.Y8G("ngIf",e.bMT(11,13,o.existingFiles$)),e.R7$(14),e.Y8G("disabled",o.isUploading),e.R7$(5),e.Y8G("ngIf",o.isUploading),e.R7$(),e.Y8G("ngIf",o.uploadStates.length>0),e.R7$(3),e.Y8G("ngIf",o.uploadSuccess),e.R7$(),e.Y8G("ngIf",o.errorMessage),e.R7$(),e.Y8G("disabled",!o.hasPendingFiles()||o.isUploading||!o.allPendingFilesHaveReason()),e.R7$(),e.Y8G("ngIf",o.isUploading),e.R7$(),e.SpI(" ",o.isUploading?"Envoi en cours...":"Envoyer les fichiers"," "),e.R7$(15),e.Y8G("ngIf",o.csvData&&o.csvData.length>0)("ngIfElse",c)}},dependencies:[G.MD,G.Sq,G.bT,G.ux,G.e1,G.fG,G.Jj,G.vh,w.YN,w.xH,w.y7,w.wz,w.BC,w.vS,H.Wk]})}return s})()},262:function(ve,ue){var C,e;C=function G(){var H,w=typeof self<"u"?self:typeof window<"u"?window:void 0!==w?w:{},W=!w.document&&!!w.postMessage,J=w.IS_PAPA_WORKER||!1,Z={},pe=0,p={};function q(r){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},function(n){var a=oe(n);a.chunkSize=parseInt(a.chunkSize),n.step||n.chunk||(a.chunkSize=null),this._handle=new ce(a),(this._handle.streamer=this)._config=a}.call(this,r),this.parseChunk=function(n,a){var u=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<u){let _=this._config.newline;_||(_=this._handle.guessLineEndings(n,l=this._config.quoteChar||'"')),n=[...n.split(_).slice(u)].join(_)}this.isFirstChunk&&S(this._config.beforeFirstChunk)&&void 0!==(l=this._config.beforeFirstChunk(n))&&(n=l),this.isFirstChunk=!1,this._halted=!1,u=this._partialLine+n;var l=(this._partialLine="",this._handle.parse(u,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(n=l.meta.cursor,this._finished||(this._partialLine=u.substring(n-this._baseIndex),this._baseIndex=n),l&&l.data&&(this._rowCount+=l.data.length),u=this._finished||this._config.preview&&this._rowCount>=this._config.preview,J)w.postMessage({results:l,workerId:p.WORKER_ID,finished:u});else if(S(this._config.chunk)&&!a){if(this._config.chunk(l,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=l=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(l.data),this._completeResults.errors=this._completeResults.errors.concat(l.errors),this._completeResults.meta=l.meta),this._completed||!u||!S(this._config.complete)||l&&l.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),u||l&&l.meta.paused||this._nextChunk(),l}this._halted=!0},this._sendError=function(n){S(this._config.error)?this._config.error(n):J&&this._config.error&&w.postMessage({workerId:p.WORKER_ID,error:n,finished:!1})}}function ee(r){var n;(r=r||{}).chunkSize||(r.chunkSize=p.RemoteChunkSize),q.call(this,r),this._nextChunk=W?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(a){this._input=a,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(n=new XMLHttpRequest,this._config.withCredentials&&(n.withCredentials=this._config.withCredentials),W||(n.onload=B(this._chunkLoaded,this),n.onerror=B(this._chunkError,this)),n.open(this._config.downloadRequestBody?"POST":"GET",this._input,!W),this._config.downloadRequestHeaders){var a,u=this._config.downloadRequestHeaders;for(a in u)n.setRequestHeader(a,u[a])}this._config.chunkSize&&n.setRequestHeader("Range","bytes="+this._start+"-"+(this._start+this._config.chunkSize-1));try{n.send(this._config.downloadRequestBody)}catch(_){this._chunkError(_.message)}W&&0===n.status&&this._chunkError()}},this._chunkLoaded=function(){var a;4===n.readyState&&(n.status<200||400<=n.status?this._chunkError():(this._start+=this._config.chunkSize||n.responseText.length,this._finished=!this._config.chunkSize||this._start>=(null!==(a=(a=n).getResponseHeader("Content-Range"))?parseInt(a.substring(a.lastIndexOf("/")+1)):-1),this.parseChunk(n.responseText)))},this._chunkError=function(a){a=n.statusText||a,this._sendError(new Error(a))}}function te(r){(r=r||{}).chunkSize||(r.chunkSize=p.LocalChunkSize),q.call(this,r);var n,a,u=typeof FileReader<"u";this.stream=function(l){this._input=l,a=l.slice||l.webkitSlice||l.mozSlice,u?((n=new FileReader).onload=B(this._chunkLoaded,this),n.onerror=B(this._chunkError,this)):n=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var l=this._input,_=(this._config.chunkSize&&(_=Math.min(this._start+this._config.chunkSize,this._input.size),l=a.call(l,this._start,_)),n.readAsText(l,this._config.encoding));u||this._chunkLoaded({target:{result:_}})},this._chunkLoaded=function(l){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(l.target.result)},this._chunkError=function(){this._sendError(n.error)}}function Q(r){var n;q.call(this,r=r||{}),this.stream=function(a){return n=a,this._nextChunk()},this._nextChunk=function(){var a,u;if(!this._finished)return n=(a=this._config.chunkSize)?(u=n.substring(0,a),n.substring(a)):(u=n,""),this._finished=!n,this.parseChunk(u)}}function re(r){q.call(this,r=r||{});var n=[],a=!0,u=!1;this.pause=function(){q.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){q.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(l){this._input=l,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){u&&1===n.length&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),n.length?this.parseChunk(n.shift()):a=!0},this._streamData=B(function(l){try{n.push("string"==typeof l?l:l.toString(this._config.encoding)),a&&(a=!1,this._checkIsFinished(),this.parseChunk(n.shift()))}catch(_){this._streamError(_)}},this),this._streamError=B(function(l){this._streamCleanUp(),this._sendError(l)},this),this._streamEnd=B(function(){this._streamCleanUp(),u=!0,this._streamData("")},this),this._streamCleanUp=B(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function ce(r){var n,a,u,l,_=Math.pow(2,53),T=-_,N=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,$=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,x=this,F=0,f=0,O=!1,v=!1,b=[],h={data:[],errors:[],meta:{}};function I(s){return"greedy"===r.skipEmptyLines?""===s.join("").trim():1===s.length&&0===s[0].length}function R(){if(h&&u&&(P("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+p.DefaultDelimiter+"'"),u=!1),r.skipEmptyLines&&(h.data=h.data.filter(function(o){return!I(o)})),D()){let o=function(c,y){S(r.transformHeader)&&(c=r.transformHeader(c,y)),b.push(c)};if(h)if(Array.isArray(h.data[0])){for(var s=0;D()&&s<h.data.length;s++)h.data[s].forEach(o);h.data.splice(0,1)}else h.data.forEach(o)}function d(o,c){for(var y=r.header?{}:[],g=0;g<o.length;g++){var m=g,U=o[g];k=m=r.header?g>=b.length?"__parsed_extra":b[g]:m,E=U=r.transform?r.transform(U,m):U,void 0,j=k,r.dynamicTypingFunction&&void 0===r.dynamicTyping[j]&&(r.dynamicTyping[j]=r.dynamicTypingFunction(j)),U=!0===(r.dynamicTyping[j]||r.dynamicTyping)?"true"===E||"TRUE"===E||"false"!==E&&"FALSE"!==E&&((j=>{if(N.test(j)&&(j=parseFloat(j),T<j&&j<_))return 1})(E)?parseFloat(E):$.test(E)?new Date(E):""===E?null:E):E,"__parsed_extra"===m?(y[m]=y[m]||[],y[m].push(U)):y[m]=U}var k,E,j;return r.header&&(g>b.length?P("FieldMismatch","TooManyFields","Too many fields: expected "+b.length+" fields but parsed "+g,f+c):g<b.length&&P("FieldMismatch","TooFewFields","Too few fields: expected "+b.length+" fields but parsed "+g,f+c)),y}var t;h&&(r.header||r.dynamicTyping||r.transform)&&(t=1,!h.data.length||Array.isArray(h.data[0])?(h.data=h.data.map(d),t=h.data.length):h.data=d(h.data,0),r.header&&h.meta&&(h.meta.fields=b),f+=t)}function D(){return r.header&&0===b.length}function P(s,d,t,i){s={type:s,code:d,message:t},void 0!==i&&(s.row=i),h.errors.push(s)}S(r.step)&&(l=r.step,r.step=function(s){h=s,D()?R():(R(),0!==h.data.length&&(F+=s.data.length,r.preview&&F>r.preview?a.abort():(h.data=h.data[0],l(h,x))))}),this.parse=function(s,d,t){var i=r.quoteChar||'"';return r.newline||(r.newline=this.guessLineEndings(s,i)),u=!1,r.delimiter?S(r.delimiter)&&(r.delimiter=r.delimiter(s),h.meta.delimiter=r.delimiter):((i=((o,c,y,g,m)=>{var U,k,E,j;m=m||[",","\t","|",";",p.RECORD_SEP,p.UNIT_SEP];for(var ne=0;ne<m.length;ne++){for(var Y,ae=m[ne],M=0,V=0,A=0,L=(E=void 0,new se({comments:g,delimiter:ae,newline:c,preview:10}).parse(o)),X=0;X<L.data.length;X++)y&&I(L.data[X])?A++:(V+=Y=L.data[X].length,void 0===E?E=Y:0<Y&&(M+=Math.abs(Y-E),E=Y));0<L.data.length&&(V/=L.data.length-A),(void 0===k||M<=k)&&(void 0===j||j<V)&&1.99<V&&(k=M,U=ae,j=V)}return{successful:!!(r.delimiter=U),bestDelimiter:U}})(s,r.newline,r.skipEmptyLines,r.comments,r.delimitersToGuess)).successful?r.delimiter=i.bestDelimiter:(u=!0,r.delimiter=p.DefaultDelimiter),h.meta.delimiter=r.delimiter),i=oe(r),r.preview&&r.header&&i.preview++,n=s,a=new se(i),h=a.parse(n,d,t),R(),O?{meta:{paused:!0}}:h||{meta:{paused:!1}}},this.paused=function(){return O},this.pause=function(){O=!0,a.abort(),n=S(r.chunk)?"":n.substring(a.getCharIndex())},this.resume=function(){x.streamer._halted?(O=!1,x.streamer.parseChunk(n,!0)):setTimeout(x.resume,3)},this.aborted=function(){return v},this.abort=function(){v=!0,a.abort(),h.meta.aborted=!0,S(r.complete)&&r.complete(h),n=""},this.guessLineEndings=function(o,i){o=o.substring(0,1048576),i=new RegExp(K(i)+"([^]*?)"+K(i),"gm");var t=(o=o.replace(i,"")).split("\r");if(o=1<(i=o.split("\n")).length&&i[0].length<t[0].length,1===t.length||o)return"\n";for(var c=0,y=0;y<t.length;y++)"\n"===t[y][0]&&c++;return c>=t.length/2?"\r\n":"\r"}}function K(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function se(r){var n=(r=r||{}).delimiter,a=r.newline,u=r.comments,l=r.step,_=r.preview,T=r.fastMode,N=null,$=!1,x=null==r.quoteChar?'"':r.quoteChar,F=x;if(void 0!==r.escapeChar&&(F=r.escapeChar),("string"!=typeof n||-1<p.BAD_DELIMITERS.indexOf(n))&&(n=","),u===n)throw new Error("Comment character same as delimiter");!0===u?u="#":("string"!=typeof u||-1<p.BAD_DELIMITERS.indexOf(u))&&(u=!1),"\n"!==a&&"\r"!==a&&"\r\n"!==a&&(a="\n");var f=0,O=!1;this.parse=function(v,b,h){if("string"!=typeof v)throw new Error("Input must be a string");var I=v.length,R=n.length,D=a.length,P=u.length,s=S(l),d=[],t=[],i=[],o=f=0;if(!v)return M();if(T||!1!==T&&-1===v.indexOf(x)){for(var c=v.split(a),y=0;y<c.length;y++){if(f+=(i=c[y]).length,y!==c.length-1)f+=a.length;else if(h)return M();if(!u||i.substring(0,P)!==u){if(s){if(d=[],j(i.split(n)),V(),O)return M()}else j(i.split(n));if(_&&_<=y)return d=d.slice(0,_),M(!0)}}return M()}for(var g=v.indexOf(n,f),m=v.indexOf(a,f),U=new RegExp(K(F)+K(x),"g"),k=v.indexOf(x,f);;)if(v[f]===x)for(k=f,f++;;){if(-1===(k=v.indexOf(x,k+1)))return h||t.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:d.length,index:f}),Y();if(k===I-1)return Y(v.substring(f,k).replace(U,x));if(x===F&&v[k+1]===F)k++;else if(x===F||0===k||v[k-1]!==F){-1!==g&&g<k+1&&(g=v.indexOf(n,k+1));var E=ne(-1===(m=-1!==m&&m<k+1?v.indexOf(a,k+1):m)?g:Math.min(g,m));if(v.substr(k+1+E,R)===n){i.push(v.substring(f,k).replace(U,x)),v[f=k+1+E+R]!==x&&(k=v.indexOf(x,f)),g=v.indexOf(n,f),m=v.indexOf(a,f);break}if(E=ne(m),v.substring(k+1+E,k+1+E+D)===a){if(i.push(v.substring(f,k).replace(U,x)),ae(k+1+E+D),g=v.indexOf(n,f),k=v.indexOf(x,f),s&&(V(),O))return M();if(_&&d.length>=_)return M(!0);break}t.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:d.length,index:f}),k++}}else if(u&&0===i.length&&v.substring(f,f+P)===u){if(-1===m)return M();m=v.indexOf(a,f=m+D),g=v.indexOf(n,f)}else if(-1!==g&&(g<m||-1===m))i.push(v.substring(f,g)),g=v.indexOf(n,f=g+R);else{if(-1===m)break;if(i.push(v.substring(f,m)),ae(m+D),s&&(V(),O))return M();if(_&&d.length>=_)return M(!0)}return Y();function j(A){d.push(A),o=f}function ne(A){return-1!==A&&(A=v.substring(k+1,A))&&""===A.trim()?A.length:0}function Y(A){return h||(void 0===A&&(A=v.substring(f)),i.push(A),f=I,j(i),s&&V()),M()}function ae(A){f=A,j(i),i=[],m=v.indexOf(a,f)}function M(A){if(r.header&&!b&&d.length&&!$){var L=d[0],X=Object.create(null),me=new Set(L);let _e=!1;for(let ie=0;ie<L.length;ie++){let z=L[ie];if(X[z=S(r.transformHeader)?r.transformHeader(z,ie):z]){let le,xe=X[z];for(;le=z+"_"+xe,xe++,me.has(le););me.add(le),L[ie]=le,X[z]++,_e=!0,(N=null===N?{}:N)[le]=z}else X[z]=1,L[ie]=z;me.add(z)}_e&&console.warn("Duplicate headers found and renamed."),$=!0}return{data:d,errors:t,meta:{delimiter:n,linebreak:a,aborted:O,truncated:!!A,cursor:o+(b||0),renamedHeaders:N}}}function V(){l(M()),d=[],t=[]}},this.abort=function(){O=!0},this.getCharIndex=function(){return f}}function ge(r){var n=r.data,a=Z[n.workerId],u=!1;if(n.error)a.userError(n.error,n.file);else if(n.results&&n.results.data){var l={abort:function(){u=!0,he(n.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:fe,resume:fe};if(S(a.userStep)){for(var _=0;_<n.results.data.length&&(a.userStep({data:n.results.data[_],errors:n.results.errors,meta:n.results.meta},l),!u);_++);delete n.results}else S(a.userChunk)&&(a.userChunk(n.results,l,n.file),delete n.results)}n.finished&&!u&&he(n.workerId,n.results)}function he(r,n){var a=Z[r];S(a.userComplete)&&a.userComplete(n),a.terminate(),delete Z[r]}function fe(){throw new Error("Not implemented.")}function oe(r){if("object"!=typeof r||null===r)return r;var n,a=Array.isArray(r)?[]:{};for(n in r)a[n]=oe(r[n]);return a}function B(r,n){return function(){r.apply(n,arguments)}}function S(r){return"function"==typeof r}return p.parse=function(r,n){var u,a=(n=n||{}).dynamicTyping||!1;if(S(a)&&(n.dynamicTypingFunction=a,a={}),n.dynamicTyping=a,n.transform=!!S(n.transform)&&n.transform,!n.worker||!p.WORKERS_SUPPORTED)return a=null,"string"==typeof r?(r=65279!==(u=r).charCodeAt(0)?u:u.slice(1),a=new(n.download?ee:Q)(n)):!0===r.readable&&S(r.read)&&S(r.on)?a=new re(n):(w.File&&r instanceof File||r instanceof Object)&&(a=new te(n)),a.stream(r);(a=(()=>{var u,l,_;return!!p.WORKERS_SUPPORTED&&(l=w.URL||w.webkitURL||null,_=G.toString(),u=p.BLOB_URL||(p.BLOB_URL=l.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",_,")();"],{type:"text/javascript"}))),(u=new w.Worker(u)).onmessage=ge,u.id=pe++,Z[u.id]=u)})()).userStep=n.step,a.userChunk=n.chunk,a.userComplete=n.complete,a.userError=n.error,n.step=S(n.step),n.chunk=S(n.chunk),n.complete=S(n.complete),n.error=S(n.error),delete n.worker,a.postMessage({input:r,config:n,workerId:a.id})},p.unparse=function(r,n){var a=!1,u=!0,l=",",_="\r\n",T='"',N=T+T,$=!1,x=null,F=!1,f=((()=>{if("object"==typeof n){if("string"!=typeof n.delimiter||p.BAD_DELIMITERS.filter(function(b){return-1!==n.delimiter.indexOf(b)}).length||(l=n.delimiter),"boolean"!=typeof n.quotes&&"function"!=typeof n.quotes&&!Array.isArray(n.quotes)||(a=n.quotes),"boolean"!=typeof n.skipEmptyLines&&"string"!=typeof n.skipEmptyLines||($=n.skipEmptyLines),"string"==typeof n.newline&&(_=n.newline),"string"==typeof n.quoteChar&&(T=n.quoteChar),"boolean"==typeof n.header&&(u=n.header),Array.isArray(n.columns)){if(0===n.columns.length)throw new Error("Option columns is empty");x=n.columns}void 0!==n.escapeChar&&(N=n.escapeChar+T),n.escapeFormulae instanceof RegExp?F=n.escapeFormulae:"boolean"==typeof n.escapeFormulae&&n.escapeFormulae&&(F=/^[=+\-@\t\r].*$/)}})(),new RegExp(K(T),"g"));if("string"==typeof r&&(r=JSON.parse(r)),Array.isArray(r)){if(!r.length||Array.isArray(r[0]))return O(null,r,$);if("object"==typeof r[0])return O(x||Object.keys(r[0]),r,$)}else if("object"==typeof r)return"string"==typeof r.data&&(r.data=JSON.parse(r.data)),Array.isArray(r.data)&&(r.fields||(r.fields=r.meta&&r.meta.fields||x),r.fields||(r.fields=Array.isArray(r.data[0])?r.fields:"object"==typeof r.data[0]?Object.keys(r.data[0]):[]),Array.isArray(r.data[0])||"object"==typeof r.data[0]||(r.data=[r.data])),O(r.fields||[],r.data||[],$);throw new Error("Unable to serialize unrecognized input");function O(b,h,I){var R="",D=("string"==typeof b&&(b=JSON.parse(b)),"string"==typeof h&&(h=JSON.parse(h)),Array.isArray(b)&&0<b.length),P=!Array.isArray(h[0]);if(D&&u){for(var s=0;s<b.length;s++)0<s&&(R+=l),R+=v(b[s],s);0<h.length&&(R+=_)}for(var d=0;d<h.length;d++){var t=(D?b:h[d]).length,i=!1,o=D?0===Object.keys(h[d]).length:0===h[d].length;if(I&&!D&&(i="greedy"===I?""===h[d].join("").trim():1===h[d].length&&0===h[d][0].length),"greedy"===I&&D){for(var c=[],y=0;y<t;y++)c.push(h[d][P?b[y]:y]);i=""===c.join("").trim()}if(!i){for(var m=0;m<t;m++)0<m&&!o&&(R+=l),R+=v(h[d][D&&P?b[m]:m],m);d<h.length-1&&(!I||0<t&&!o)&&(R+=_)}}return R}function v(b,h){var I,R;return null==b?"":b.constructor===Date?JSON.stringify(b).slice(1,25):(R=!1,F&&"string"==typeof b&&F.test(b)&&(b="'"+b,R=!0),I=b.toString().replace(f,N),(R=R||!0===a||"function"==typeof a&&a(b,h)||Array.isArray(a)&&a[h]||((D,P)=>{for(var s=0;s<P.length;s++)if(-1<D.indexOf(P[s]))return!0;return!1})(I,p.BAD_DELIMITERS)||-1<I.indexOf(l)||" "===I.charAt(0)||" "===I.charAt(I.length-1))?T+I+T:I)}},p.RECORD_SEP="\x1e",p.UNIT_SEP="\x1f",p.BYTE_ORDER_MARK="\ufeff",p.BAD_DELIMITERS=["\r","\n",'"',p.BYTE_ORDER_MARK],p.WORKERS_SUPPORTED=!W&&!!w.Worker,p.NODE_STREAM_INPUT=1,p.LocalChunkSize=10485760,p.RemoteChunkSize=5242880,p.DefaultDelimiter=",",p.Parser=se,p.ParserHandle=ce,p.NetworkStreamer=ee,p.FileStreamer=te,p.StringStreamer=Q,p.ReadableStreamStreamer=re,w.jQuery&&((H=w.jQuery).fn.parse=function(r){var n=r.config||{},a=[];return this.each(function(_){if("INPUT"!==H(this).prop("tagName").toUpperCase()||"file"!==H(this).attr("type").toLowerCase()||!w.FileReader||!this.files||0===this.files.length)return!0;for(var T=0;T<this.files.length;T++)a.push({file:this.files[T],inputElem:this,instanceConfig:H.extend({},n)})}),u(),this;function u(){if(0===a.length)S(r.complete)&&r.complete();else{var T,N,$,x=a[0];if(S(r.before)){var F=r.before(x.file,x.inputElem);if("object"==typeof F){if("abort"===F.action)return T=x.file,N=x.inputElem,$=F.reason,void(S(r.error)&&r.error({name:"AbortError"},T,N,$));if("skip"===F.action)return void l();"object"==typeof F.config&&(x.instanceConfig=H.extend(x.instanceConfig,F.config))}else if("skip"===F)return void l()}var f=x.instanceConfig.complete;x.instanceConfig.complete=function(O){S(f)&&f(O,x.file,x.inputElem),l()},p.parse(x.file,x.instanceConfig)}}function l(){a.splice(0,1),u()}}),J&&(w.onmessage=function(r){r=r.data,void 0===p.WORKER_ID&&r&&(p.WORKER_ID=r.workerId),"string"==typeof r.input?w.postMessage({workerId:p.WORKER_ID,results:p.parse(r.input,r.config),finished:!0}):(w.File&&r.input instanceof File||r.input instanceof Object)&&(r=p.parse(r.input,r.config))&&w.postMessage({workerId:p.WORKER_ID,results:r,finished:!0})}),(ee.prototype=Object.create(q.prototype)).constructor=ee,(te.prototype=Object.create(q.prototype)).constructor=te,(Q.prototype=Object.create(Q.prototype)).constructor=Q,(re.prototype=Object.create(q.prototype)).constructor=re,p},void 0!==(e=C.apply(ue,[]))&&(ve.exports=e)}}]);