"use strict";(self.webpackChunkassurkin=self.webpackChunkassurkin||[]).push([[199],{2199:(M,c,s)=>{s.r(c),s.d(c,{PaymentComponent:()=>G});var u=s(467),e=s(4438),d=s(177),l=s(9417),m=s(8212),g=s(9499),_=s(3161),p=s(5558),f=s(7673),y=s(3207);const b=(n,a)=>({"z-10 bg-indigo-50 border-indigo-500 text-indigo-600":n,"bg-white border-gray-300 text-gray-500 hover:bg-gray-50":a});function v(n,a){1&n&&(e.j41(0,"div",5),e.nrm(1,"div",6),e.j41(2,"p",7),e.EFF(3,"Chargement..."),e.k0s()())}function h(n,a){if(1&n&&(e.j41(0,"div",8)(1,"span",9),e.EFF(2),e.k0s()()),2&n){const t=e.XpG();e.R7$(2),e.JRh(t.errorMessage)}}function P(n,a){if(1&n){const t=e.RV6();e.j41(0,"div",14)(1,"div",15)(2,"input",16),e.bIt("ngModelChange",function(r){e.eBV(t);const o=e.XpG(2);return e.Njj(o.onSearchChange(r))}),e.k0s(),e.j41(3,"div",17),e.nrm(4,"i",18),e.k0s()()()}if(2&n){const t=e.XpG(2);e.R7$(2),e.Y8G("ngModel",t.searchTerm)}}function x(n,a){1&n&&(e.j41(0,"div",19)(1,"p",20),e.EFF(2,"Aucune demande de paiement trouv\xe9e."),e.k0s()())}function E(n,a){1&n&&(e.j41(0,"div",19)(1,"p",20),e.EFF(2,"Aucun r\xe9sultat ne correspond \xe0 votre recherche."),e.k0s()())}function j(n,a){1&n&&(e.j41(0,"span"),e.nrm(1,"i",33),e.EFF(2," Envoi..."),e.k0s())}function F(n,a){1&n&&(e.j41(0,"span"),e.nrm(1,"i",34),e.EFF(2," Relancer"),e.k0s())}function R(n,a){if(1&n){const t=e.RV6();e.j41(0,"button",32),e.bIt("click",function(){e.eBV(t);const r=e.XpG().$implicit,o=e.XpG(3);return e.Njj(o.resendReminder(r))}),e.DNE(1,j,3,0,"span",4)(2,F,3,0,"span",4),e.k0s()}if(2&n){const t=e.XpG().$implicit,i=e.XpG(3);e.Y8G("disabled",i.sendingEmailId===t.id),e.R7$(),e.Y8G("ngIf",i.sendingEmailId===t.id),e.R7$(),e.Y8G("ngIf",i.sendingEmailId!==t.id)}}function k(n,a){if(1&n&&(e.j41(0,"tr")(1,"td",25),e.EFF(2),e.nI1(3,"date"),e.k0s(),e.j41(4,"td",25)(5,"p",26),e.EFF(6),e.k0s()(),e.j41(7,"td",25)(8,"p",27),e.EFF(9),e.nI1(10,"currency"),e.k0s()(),e.j41(11,"td",25)(12,"span",28),e.nrm(13,"span",29),e.j41(14,"span",30),e.EFF(15),e.k0s()()(),e.j41(16,"td",25)(17,"p",26),e.EFF(18),e.k0s()(),e.j41(19,"td",25),e.DNE(20,R,3,3,"button",31),e.k0s()()),2&n){const t=a.$implicit,i=e.XpG(3);e.R7$(2),e.SpI(" ",e.i5U(3,8,t.created_at,"dd/MM/yyyy HH:mm")," "),e.R7$(4),e.JRh(t.sujet),e.R7$(3),e.SpI(" ",e.ii3(10,11,t.montant,"EUR","symbol","1.2-2")," "),e.R7$(3),e.Y8G("ngClass",i.getStatusClass(t.statut)),e.R7$(3),e.JRh(i.getStatusLabel(t.statut)),e.R7$(3),e.Lme(" ",t.quote_type," #",t.quote_id," "),e.R7$(2),e.Y8G("ngIf","pending"===t.statut)}}function C(n,a){if(1&n&&(e.j41(0,"div",21)(1,"table",22)(2,"thead")(3,"tr")(4,"th",23),e.EFF(5," Date "),e.k0s(),e.j41(6,"th",23),e.EFF(7," Sujet "),e.k0s(),e.j41(8,"th",23),e.EFF(9," Montant "),e.k0s(),e.j41(10,"th",23),e.EFF(11," Statut "),e.k0s(),e.j41(12,"th",23),e.EFF(13," Dossier "),e.k0s(),e.j41(14,"th",23),e.EFF(15," Actions "),e.k0s()()(),e.j41(16,"tbody"),e.DNE(17,k,21,16,"tr",24),e.k0s()()()),2&n){const t=e.XpG(2);e.R7$(17),e.Y8G("ngForOf",t.paginatedPayments)}}function I(n,a){if(1&n){const t=e.RV6();e.qex(0),e.j41(1,"button",48),e.bIt("click",function(){const r=e.eBV(t).$implicit,o=e.XpG(3);return e.Njj(o.goToPage(r))}),e.EFF(2),e.k0s(),e.bVm()}if(2&n){const t=a.$implicit,i=e.XpG(3);e.R7$(),e.Y8G("ngClass",e.l_i(2,b,t===i.currentPage,t!==i.currentPage)),e.R7$(),e.SpI(" ",t," ")}}function T(n,a){if(1&n){const t=e.RV6();e.j41(0,"div",35)(1,"div",36)(2,"button",37),e.bIt("click",function(){e.eBV(t);const r=e.XpG(2);return e.Njj(r.goToPage(r.currentPage-1))}),e.EFF(3," Pr\xe9c\xe9dent "),e.k0s(),e.j41(4,"button",38),e.bIt("click",function(){e.eBV(t);const r=e.XpG(2);return e.Njj(r.goToPage(r.currentPage+1))}),e.EFF(5," Suivant "),e.k0s()(),e.j41(6,"div",39)(7,"div")(8,"p",40),e.EFF(9," Affichage de "),e.j41(10,"span",41),e.EFF(11),e.k0s(),e.EFF(12," \xe0 "),e.j41(13,"span",41),e.EFF(14),e.k0s(),e.EFF(15," sur "),e.j41(16,"span",41),e.EFF(17),e.k0s(),e.EFF(18," r\xe9sultats "),e.k0s()(),e.j41(19,"div")(20,"nav",42)(21,"button",43),e.bIt("click",function(){e.eBV(t);const r=e.XpG(2);return e.Njj(r.goToPage(r.currentPage-1))}),e.j41(22,"span",44),e.EFF(23,"Pr\xe9c\xe9dent"),e.k0s(),e.nrm(24,"i",45),e.k0s(),e.DNE(25,I,3,5,"ng-container",24),e.j41(26,"button",46),e.bIt("click",function(){e.eBV(t);const r=e.XpG(2);return e.Njj(r.goToPage(r.currentPage+1))}),e.j41(27,"span",44),e.EFF(28,"Suivant"),e.k0s(),e.nrm(29,"i",47),e.k0s()()()()()}if(2&n){const t=e.XpG(2);e.R7$(2),e.Y8G("disabled",1===t.currentPage),e.R7$(2),e.Y8G("disabled",t.currentPage===t.getTotalPages()),e.R7$(7),e.JRh((t.currentPage-1)*t.itemsPerPage+1),e.R7$(3),e.JRh(t.currentPage*t.itemsPerPage>t.filteredPayments.length?t.filteredPayments.length:t.currentPage*t.itemsPerPage),e.R7$(3),e.JRh(t.filteredPayments.length),e.R7$(4),e.Y8G("disabled",1===t.currentPage),e.R7$(4),e.Y8G("ngForOf",t.getPagesArray()),e.R7$(),e.Y8G("disabled",t.currentPage===t.getTotalPages())}}function $(n,a){if(1&n&&(e.j41(0,"div"),e.DNE(1,P,5,1,"div",10)(2,x,3,0,"div",11)(3,E,3,0,"div",11)(4,C,18,1,"div",12)(5,T,30,8,"div",13),e.k0s()),2&n){const t=e.XpG();e.R7$(),e.Y8G("ngIf",t.payments.length>0),e.R7$(),e.Y8G("ngIf",0===t.payments.length),e.R7$(),e.Y8G("ngIf",t.payments.length>0&&0===t.paginatedPayments.length),e.R7$(),e.Y8G("ngIf",t.paginatedPayments.length>0),e.R7$(),e.Y8G("ngIf",t.getTotalPages()>1)}}let G=(()=>{class n{paymentService=(0,e.WQX)(m.W);authService=(0,e.WQX)(g.u);mailService=(0,e.WQX)(_.t);payments=[];filteredPayments=[];loading=!0;errorMessage=null;sendingEmailId=null;paginatedPayments=[];currentPage=1;itemsPerPage=15;searchTerm="";ngOnInit(){this.authService.currentUser$.pipe((0,p.n)(t=>t?this.paymentService.getPaymentRequestsByUser(t.id):(0,f.of)([]))).subscribe({next:t=>{this.payments=t,this.filteredPayments=t,this.loading=!1,this.currentPage=1,this.updatePaginatedPayments()},error:t=>{console.error("Erreur chargement historique paiements",t),this.errorMessage="Impossible de charger l'historique des paiements.",this.loading=!1}})}getStatusLabel(t){switch(t){case"pending":return"En attente";case"paid":return"Pay\xe9";case"failed":return"\xc9chou\xe9";case"cancelled":return"Annul\xe9";case"overdue":return"En retard";default:return t}}getStatusClass(t){switch(t){case"paid":return"bg-green-100 text-green-800";case"pending":return"bg-yellow-100 text-yellow-800";case"failed":case"overdue":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}}resendReminder(t){var i=this;return(0,u.A)(function*(){if(t.preneur_uid){if(confirm("Voulez-vous envoyer un rappel de paiement par e-mail au client ?")){i.sendingEmailId=t.id;try{const r=yield i.paymentService.getPersonDetails(t.preneur_uid);if(!r||!r.email)return void alert("Impossible de r\xe9cup\xe9rer l'email du client.");const o=`\n        <p>Bonjour ${r.prenom} ${r.nom},</p>\n        <p>Sauf erreur de notre part, nous sommes toujours dans l'attente du r\xe8glement concernant votre dossier ${t.quote_type} #${t.quote_id}.</p>\n        <p><strong>Objet :</strong> ${t.sujet}</p>\n        <p><strong>Montant \xe0 r\xe9gler :</strong> ${t.montant} \u20ac</p>\n        <p><strong>Date limite :</strong> ${new Date(t.date_echeance).toLocaleDateString()}</p>\n        <p>Merci de r\xe9gulariser votre situation dans les plus brefs d\xe9lais via votre espace client.</p>\n        <p>Cordialement,<br>L'\xe9quipe Assurkin</p>\n      `;yield(0,y.s)(i.mailService.sendEmail({to:r.email,subject:`Rappel : Paiement en attente - Dossier #${t.quote_id}`,htmlContent:o})),alert("Rappel envoy\xe9 avec succ\xe8s !")}catch(r){console.error("Erreur lors de l'envoi du rappel:",r),alert("Une erreur est survenue lors de l'envoi du rappel.")}finally{i.sendingEmailId=null}}}else alert("Impossible de relancer : aucun client associ\xe9 \xe0 ce paiement.")})()}onSearchChange(t){if(this.searchTerm=t,this.currentPage=1,this.searchTerm){const i=this.searchTerm.toLowerCase();this.filteredPayments=this.payments.filter(r=>r.sujet.toLowerCase().includes(i)||r.montant.toString().includes(i)||(r.quote_type+" #"+r.quote_id).toLowerCase().includes(i))}else this.filteredPayments=this.payments;this.updatePaginatedPayments()}updatePaginatedPayments(){const t=(this.currentPage-1)*this.itemsPerPage;this.paginatedPayments=this.filteredPayments.slice(t,t+this.itemsPerPage)}goToPage(t){this.currentPage=t,this.updatePaginatedPayments()}getTotalPages(){return Math.ceil(this.filteredPayments.length/this.itemsPerPage)}getPagesArray(){return Array(this.getTotalPages()).fill(0).map((t,i)=>i+1)}static \u0275fac=function(i){return new(i||n)};static \u0275cmp=e.VBU({type:n,selectors:[["app-payment"]],standalone:!0,features:[e.aNF],decls:6,vars:3,consts:[[1,"container","mx-auto","px-4","py-8"],[1,"text-2xl","font-bold","mb-6","text-gray-800"],["class","text-center py-8",4,"ngIf"],["class","bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4","role","alert",4,"ngIf"],[4,"ngIf"],[1,"text-center","py-8"],[1,"inline-block","animate-spin","rounded-full","h-8","w-8","border-b-2","border-gray-900"],[1,"mt-2","text-gray-600"],["role","alert",1,"bg-red-100","border","border-red-400","text-red-700","px-4","py-3","rounded","relative","mb-4"],[1,"block","sm:inline"],["class","flex justify-end mb-4",4,"ngIf"],["class","text-center py-8 bg-gray-50 rounded-lg",4,"ngIf"],["class","overflow-x-auto bg-white shadow-md rounded-lg",4,"ngIf"],["class","bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-4 rounded-b-lg shadow-md",4,"ngIf"],[1,"flex","justify-end","mb-4"],[1,"relative","w-full","max-w-xs"],["type","text","placeholder","Rechercher par sujet ou montant",1,"block","w-full","pl-10","pr-3","py-2","border","border-gray-300","rounded-md","leading-5","bg-white","placeholder-gray-500","focus:outline-none","focus:placeholder-gray-400","focus:ring-1","focus:ring-indigo-500","focus:border-indigo-500","sm:text-sm",3,"ngModelChange","ngModel"],[1,"absolute","inset-y-0","left-0","pl-3","flex","items-center","pointer-events-none"],[1,"fas","fa-search","text-gray-400"],[1,"text-center","py-8","bg-gray-50","rounded-lg"],[1,"text-gray-500"],[1,"overflow-x-auto","bg-white","shadow-md","rounded-lg"],[1,"min-w-full","leading-normal"],[1,"px-5","py-3","border-b-2","border-gray-200","bg-gray-100","text-left","text-xs","font-semibold","text-gray-600","uppercase","tracking-wider"],[4,"ngFor","ngForOf"],[1,"px-5","py-5","border-b","border-gray-200","bg-white","text-sm"],[1,"text-gray-900","whitespace-no-wrap"],[1,"text-gray-900","whitespace-no-wrap","font-bold"],[1,"relative","inline-block","px-3","py-1","font-semibold","leading-tight","rounded-full",3,"ngClass"],["aria-hidden","true",1,"absolute","inset-0","opacity-50","rounded-full"],[1,"relative"],["class","text-indigo-600 hover:text-indigo-900 font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150",3,"disabled","click",4,"ngIf"],[1,"text-indigo-600","hover:text-indigo-900","font-medium","disabled:opacity-50","disabled:cursor-not-allowed","transition-colors","duration-150",3,"click","disabled"],[1,"fas","fa-spinner","fa-spin","mr-1"],[1,"fas","fa-paper-plane","mr-1"],[1,"bg-white","px-4","py-3","flex","items-center","justify-between","border-t","border-gray-200","sm:px-6","mt-4","rounded-b-lg","shadow-md"],[1,"flex-1","flex","justify-between","sm:hidden"],[1,"relative","inline-flex","items-center","px-4","py-2","border","border-gray-300","text-sm","font-medium","rounded-md","text-gray-700","bg-white","hover:bg-gray-50","disabled:opacity-50",3,"click","disabled"],[1,"ml-3","relative","inline-flex","items-center","px-4","py-2","border","border-gray-300","text-sm","font-medium","rounded-md","text-gray-700","bg-white","hover:bg-gray-50","disabled:opacity-50",3,"click","disabled"],[1,"hidden","sm:flex-1","sm:flex","sm:items-center","sm:justify-between"],[1,"text-sm","text-gray-700"],[1,"font-medium"],["aria-label","Pagination",1,"relative","z-0","inline-flex","rounded-md","shadow-sm","-space-x-px"],[1,"relative","inline-flex","items-center","px-2","py-2","rounded-l-md","border","border-gray-300","bg-white","text-sm","font-medium","text-gray-500","hover:bg-gray-50","disabled:opacity-50",3,"click","disabled"],[1,"sr-only"],[1,"fas","fa-chevron-left","h-5","w-5"],[1,"relative","inline-flex","items-center","px-2","py-2","rounded-r-md","border","border-gray-300","bg-white","text-sm","font-medium","text-gray-500","hover:bg-gray-50","disabled:opacity-50",3,"click","disabled"],[1,"fas","fa-chevron-right","h-5","w-5"],[1,"relative","inline-flex","items-center","px-4","py-2","border","text-sm","font-medium",3,"click","ngClass"]],template:function(i,r){1&i&&(e.j41(0,"div",0)(1,"h2",1),e.EFF(2,"Historique des demandes de paiement cr\xe9\xe9es"),e.k0s(),e.DNE(3,v,4,0,"div",2)(4,h,3,1,"div",3)(5,$,6,5,"div",4),e.k0s()),2&i&&(e.R7$(3),e.Y8G("ngIf",r.loading),e.R7$(),e.Y8G("ngIf",r.errorMessage),e.R7$(),e.Y8G("ngIf",!r.loading&&!r.errorMessage))},dependencies:[d.MD,d.YU,d.Sq,d.bT,d.oe,d.vh,l.YN,l.me,l.BC,l.vS],encapsulation:2})}return n})()}}]);